<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ai-Ustaz - –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫—É—Ä—Å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito Sans';
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
            color: #2d3748;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ */
        body.dark-theme {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            color: #e2e8f0;
        }
        
        body.dark-theme .glass-card {
            background: rgba(45, 55, 72, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body.dark-theme .theory-section {
            background: linear-gradient(135deg, #2d3748 0%, #374151 100%);
            border-left-color: #4c6ef5;
        }
        
        body.dark-theme .info-box {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a7c 100%);
            border-left-color: #60a5fa;
        }
        
        body.dark-theme .warning-box {
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
            border-left-color: #fbbf24;
        }
        
        body.dark-theme .success-box {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            border-left-color: #34d399;
        }
        
        body.dark-theme .example-box {
            background: #374151;
            border-color: #4b5563;
        }
        
        body.dark-theme p,
        body.dark-theme h1,
        body.dark-theme h2,
        body.dark-theme h3 {
            color: #e2e8f0;
        }
        
        body.dark-theme .theory-title {
            color: #f3f4f6;
        }
        
        body.dark-theme .btn-secondary {
            background: rgba(55, 65, 81, 0.9);
            color: #e2e8f0;
            border-color: #4b5563;
        }
        
        body.dark-theme .code-block {
            background: #1e293b;
            border-color: #334155;
        }
        
        /* –î–µ–∫–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ –∫—Ä—É–≥–∏ */
        body::before,
        body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            opacity: 0.08;
            z-index: 0;
        }

        body::before {
            width: 500px;
            height: 500px;
            background: #3559D5;
            top: -150px;
            right: -100px;
        }

        body::after {
            width: 350px;
            height: 350px;
            background: #3559D5;
            bottom: -100px;
            left: -80px;
        }
        
        .glass-card {
            position: relative;
            z-index: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3559D5);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            border: 1px solid #e2e8f0;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: white;
            border-color: #3559D5;
            color: #3559D5;
        }
        
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .certificate-preview {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #cbd5e0;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            position: relative;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .certificate-content {
            text-align: center;
            width: 100%;
        }
        
        .university-name {
            font-size: 18px;
            font-weight: bold;
            color: #1e3a8a;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .certificate-title {
            font-size: 32px;
            font-weight: bold;
            color: #dc2626;
            margin-bottom: 30px;
            text-transform: uppercase;
        }
        
        .student-name {
            font-size: 28px;
            font-weight: bold;
            color: #1e40af;
            margin: 20px 0;
            text-transform: uppercase;
        }
        
        .course-title {
            font-size: 20px;
            font-weight: bold;
            color: #dc2626;
            margin: 15px 0;
        }
        
        .completion-date {
            font-size: 16px;
            color: #6b7280;
            margin-top: 20px;
        }
        
        .signatures {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: 40px;
        }
        
        .signature {
            text-align: center;
            font-size: 12px;
            color: #374151;
        }
        
        .certificate-border {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            pointer-events: none;
        }

        .progress-bar {
            height: 8px;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3559D5);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–æ—Ä–∏–∏ */
        .theory-content {
            line-height: 1.8;
            color: #2d3748;
        }
        
        .theory-section {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-left: 4px solid #3559D5;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .theory-section:hover {
            box-shadow: 0 6px 20px rgba(53, 89, 213, 0.15);
            transform: translateY(-2px);
        }
        
        .theory-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3559D5, #4c6ef5);
            border-radius: 12px;
            color: white;
            font-size: 24px;
            margin-right: 16px;
            box-shadow: 0 4px 12px rgba(53, 89, 213, 0.3);
        }
        
        .theory-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .theory-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
            margin: 0;
        }
        
        .term-highlight {
            background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 700;
            color: #92400e;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.2);
        }
        
        .info-box {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 4px solid #3b82f6;
            border-radius: 12px;
            padding: 16px 20px;
            margin: 16px 0;
            display: flex;
            align-items: start;
        }
        
        .info-box-icon {
            font-size: 24px;
            margin-right: 12px;
            color: #1e40af;
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            border-radius: 12px;
            padding: 16px 20px;
            margin: 16px 0;
            display: flex;
            align-items: start;
        }
        
        .warning-box-icon {
            font-size: 24px;
            margin-right: 12px;
            color: #92400e;
        }
        
        .success-box {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-left: 4px solid #10b981;
            border-radius: 12px;
            padding: 16px 20px;
            margin: 16px 0;
            display: flex;
            align-items: start;
        }
        
        .success-box-icon {
            font-size: 24px;
            margin-right: 12px;
            color: #065f46;
        }
        
        .example-box {
            background: #f8fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }
        
        .example-title {
            display: flex;
            align-items: center;
            font-weight: 700;
            color: #3559D5;
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .example-title i {
            margin-right: 8px;
        }
        
        .key-points {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .key-points-title {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 16px;
        }
        
        .key-points-title i {
            color: #3559D5;
            margin-right: 10px;
        }
        
        .key-point-item {
            display: flex;
            align-items: start;
            padding: 12px;
            margin: 8px 0;
            background: #f8fafc;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .key-point-item:hover {
            background: #e2e8f0;
            transform: translateX(4px);
        }
        
        .key-point-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #3559D5, #4c6ef5);
            color: white;
            border-radius: 50%;
            font-weight: 700;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .emoji-header {
            font-size: 28px;
            margin-right: 12px;
        }
        
        .quiz-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 12px;
            user-select: none;
            -webkit-user-select: none;
        }
        
        .quiz-option:hover {
            border-color: #3559D5;
            transform: translateY(-2px);
            background: rgba(53, 89, 213, 0.05);
        }
        
        .quiz-option.selected {
            border-color: #3559D5;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }
        
        .quiz-option.locked {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .quiz-option.locked.selected {
            border-color: #3559D5;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
        }
        
        .code-editor {
            background: #1a202c;
            border: 1px solid #2d3748;
            border-radius: 12px;
            padding: 20px;
            font-family: 'Nunito Sans';
            font-size: 14px;
            color: #e2e8f0;
            min-height: 200px;
            resize: vertical;
            line-height: 1.5;
            width: 100%;
            box-sizing: border-box;
        }
        
        .flashcard {
            perspective: 1000px;
            height: 300px;
            cursor: pointer;
        }
        
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .flashcard-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, #3559D5);
            color: white;
        }
        
        .sidebar-item {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .sidebar-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #3559D5);
            color: white;
            border-color: #3559D5;
        }
        
        .sidebar-item.completed {
            background: rgba(72, 187, 120, 0.1);
            border-color: #48bb78;
            color: #2d3748;
        }
        
        .upload-zone {
            border: 3px dashed #cbd5e0;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-zone:hover {
            border-color: #3559D5;
            background: rgba(255, 255, 255, 0.95);
        }
        
        .spinner {
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #3559D5;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .theory-content {
            line-height: 1.8;
            font-size: 16px;
            color: #4a5568;
        }
        
        .theory-content p {
            margin-bottom: 20px;
        }

        .icon-large {
            font-size: 3rem;
            margin-bottom: 1.5rem;
            color: #667eea;
        }

        .page-indicator {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .page-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e0;
            transition: all 0.3s ease;
        }

        .page-dot.active {
            background: #3559D5;
            width: 24px;
            border-radius: 6px;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .loading-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .small-spinner {
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top-color: #3559D5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        .certificate-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .logo-img {
            height: 80px;
            width: auto;
            filter: drop-shadow(0 4px 8px rgba(53, 89, 213, 0.2));
        }

        .certificate-logo {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        #app {
            position: relative;
            z-index: 1;
        }

        .header {
            position: relative;
            z-index: 10;
            background: transparent;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px 0;
        }

        .header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }


        .lang-switcher {
            display: flex;
            gap: 8px;
            background: rgba(53, 89, 213, 0.1);
            padding: 4px;
            border-radius: 8px;
        }
        
        .theme-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(53, 89, 213, 0.1);
            color: #3559D5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            margin-left: 12px;
        }
        
        .theme-toggle:hover {
            background: rgba(53, 89, 213, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(53, 89, 213, 0.2);
        }
        
        body.dark-theme .theme-toggle {
            background: rgba(255, 255, 255, 0.1);
            color: #fbbf24;
        }
        
        body.dark-theme .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lang-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: #4a5568;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .lang-btn.active {
            background: #3559D5;
            color: white;
        }

        .home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .home-btn:hover {
            background: white;
            border-color: #3559D5;
            color: #3559D5;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(53, 89, 213, 0.2);
        }

        .lang-btn:hover:not(.active) {
            background: rgba(53, 89, 213, 0.2);
        }


        
        
        /* ========== –°–¢–ò–õ–ò –î–õ–Ø –¢–ï–û–†–ò–ò –ö–ê–ö –ù–ê –°–ö–†–ò–ù–®–û–¢–ï ========== */
        
        .theory-content {
            font-size: 16px;
            line-height: 1.8;
            color: #2d3748;
        }
        
        .theory-content h2 {
            font-size: 30px;
            font-weight: 700;
            color: #1a202c;
            margin: 30px 0 20px 0;
        }
        
        .theory-content h3 {
            font-size: 24px;
            font-weight: 600;
            color: #2d3748;
            margin: 24px 0 16px 0;
        }
        
        .theory-content p {
            margin-bottom: 20px;
            line-height: 1.8;
            color: #4a5568;
        }
        
        .theory-content ul {
            margin: 20px 0;
            padding-left: 30px;
        }
        
        .theory-content li {
            margin-bottom: 12px;
            color: #4a5568;
            position: relative;
        }
        
        .theory-content li strong {
            color: #2d3748;
            font-weight: 600;
        }
        
        /* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∏–∑ –ø—Ä–∏–º–µ—Ä–∞ */
        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 5px solid #2196F3;
            padding: 20px 20px 20px 60px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.15);
            position: relative;
        }
        
        .info-box::before {
            content: '‚ÑπÔ∏è';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
        }
        
        .info-box p {
            color: #1565c0;
            margin: 0;
            line-height: 1.6;
        }
        
        .info-box strong {
            color: #0d47a1;
            font-size: 1.1em;
        }
        
        .tip-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 5px solid #4CAF50;
            padding: 20px 20px 20px 60px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.15);
            position: relative;
        }
        
        .tip-box::before {
            content: 'üí°';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
        }
        
        .tip-box p {
            color: #2e7d32;
            margin: 0;
            line-height: 1.6;
        }
        
        .tip-box strong {
            color: #1b5e20;
            font-size: 1.1em;
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 5px solid #ff9800;
            padding: 20px 20px 20px 60px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.15);
            position: relative;
        }
        
        .warning-box::before {
            content: '‚ö†Ô∏è';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
        }
        
        .warning-box p {
            color: #e65100;
            margin: 0;
            line-height: 1.6;
        }
        
        .warning-box strong {
            color: #bf360c;
            font-size: 1.1em;
        }
        
        .example-box {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            border-left: 5px solid #9c27b0;
            padding: 20px 20px 20px 60px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.15);
            position: relative;
        }
        
        .example-box::before {
            content: 'üìù';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 28px;
        }
        
        .example-box p {
            color: #6a1b9a;
            margin: 0;
            line-height: 1.6;
        }
        
        .example-box strong {
            color: #4a148c;
            font-size: 1.1em;
        }
        
        /* –ë–ª–æ–∫–∏ –∫–æ–¥–∞ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ */
        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .code-block code {
            display: block;
            line-height: 1.6;
            font-size: 14px;
            white-space: pre;
        }
        
        .code-header {
            display: none; /* –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ */
        }
        
        .code-body {
            padding: 0;
        }
        
        .code-body pre {
            margin: 0;
            padding: 0;
        }
        
        /* –ë–ª–æ–∫–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π */
        .explanation-box {
            background: #f5f5f5;
            padding: 16px;
            border-radius: 8px;
            margin: 12px 0;
        }
        
        .explanation-box p {
            margin: 0;
            color: #2d3748;
        }
        
        .explanation-box .font-semibold {
            color: #1a202c;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .theory-content {
                font-size: 16px;
            }
            
            .theory-content h2 {
                font-size: 24px;
            }
            
            .theory-content h3 {
                font-size: 20px;
            }
            
            .code-block {
                font-size: 12px;
            }
        }

    </style>
</head>
<body>
    <!-- Header with Logo and Language Switcher -->
    <div class="header">
        <div class="container">
            <div class="flex justify-between items-center">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <a href="http://localhost:8000" class="home-btn">
                        <i class="fas fa-home"></i> <span class="home-btn-text" data-kk="–ë–∞—Å—Ç—ã –±–µ—Ç" data-ru="–ù–∞ –≥–ª–∞–≤–Ω—É—é">–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
                    </a>
            <img src="/static/images/logo.svg" alt="Ai-Ustaz Logo" class="logo-img" onerror="this.style.display='none'">
            <!--h1 style="font-size: 20px;">AMANZHOLOV UNIVERSITY <br> AI-SANA</h1-->
                </div>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="lang-switcher">
                        <button class="lang-btn active" onclick="switchLanguage('kk')" id="lang-kk">“ö–ê–ó</button>
                        <button class="lang-btn" onclick="switchLanguage('ru')" id="lang-ru">–†–£–°</button>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="app">
        <!-- –ù–∞—á–∏–Ω–∞–µ–º —Å—Ä–∞–∑—É —Å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="max-w-2xl w-full fade-in">
                <div class="glass-card p-8">
                    <div class="text-center mb-8">
                        <h1 class="text-4xl font-bold mb-2" style="color: #3559D5;">–°–æ–∑–¥–∞–π—Ç–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫—É—Ä—Å</h1>
                        <p class="text-gray-600">–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF-—Ñ–∞–π–ª –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–∫—Ä–æ–æ–±—É—á–µ–Ω–∏—è</p>
                    </div>

                    <div class="mb-6">
                        <div class="upload-zone" onclick="document.getElementById('pdf-input').click()">
                            <div class="icon-large">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2 text-gray-800">–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF-—Ñ–∞–π–ª</h3>
                            <p class="text-gray-500 mb-4">–ö–ª–∏–∫–Ω–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –≤ —ç—Ç—É –æ–±–ª–∞—Å—Ç—å</p>
                            <p id="file-name" class="text-sm text-gray-400">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</p>
                            <input type="file" id="pdf-input" accept=".pdf" 
                                   onchange="handleFileSelect(event)" class="hidden">
                        </div>
                    </div>

                    <button id="generate-btn" onclick="generateMicrolearning()" 
                            disabled class="btn-primary w-full text-lg py-4">
                        <i class="fas fa-robot mr-2"></i>–°–æ–∑–¥–∞—Ç—å –º–∏–∫—Ä–æ–æ–±—É—á–µ–Ω–∏–µ
                    </button>

                    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É -->
                    <div class="text-center mt-6">
                        <button onclick="showMainPage()" class="btn-secondary">
                            <i class="fas fa-book mr-2"></i>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫—É—Ä—Å–æ–≤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π state –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const state = {
            step: 'upload', // –ù–∞—á–∏–Ω–∞–µ–º —Å—Ä–∞–∑—É —Å –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
            pdfFile: null,
            currentCourse: null,
            courses: [],
            currentModule: null,
            currentTheoryPage: 0,
            currentCardIndex: 0,
            currentQuestionIndex: 0,
            quizAnswers: [],
            quizResults: null,
            completedModules: {},
            practicalCode: '',
            practicalOutput: '',
            practicalCheckResult: null,
            checkingAnswer: false,
            certificateData: null,
            lockedQuestions: new Set(),
            aiCheckResults: {},  // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ò–ò –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤
            checkingShortAnswer: false  // –§–ª–∞–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        };

        // –ü–µ—Ä–µ–≤–æ–¥—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const translations = {
            ru: {
                createCourse: "–°–æ–∑–¥–∞–π—Ç–µ —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∫—É—Ä—Å",
                uploadDescription: "–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF-—Ñ–∞–π–ª –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–∏–∫—Ä–æ–æ–±—É—á–µ–Ω–∏—è",
                uploadPdf: "–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF-—Ñ–∞–π–ª",
                clickOrDrag: "–ö–ª–∏–∫–Ω–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª –≤ —ç—Ç—É –æ–±–ª–∞—Å—Ç—å",
                fileNotSelected: "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω",
                createMicrolearning: "–°–æ–∑–¥–∞—Ç—å",
                toMainPage: "–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫—É—Ä—Å–æ–≤",
                toUploadPage: "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫—É—Ä—Å",
                generatingCourse: "–°–æ–∑–¥–∞—é –∫—É—Ä—Å...",
                analyzingMaterial: "AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –∏ —Å–æ–∑–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç",
                mayTakeTime: "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç",
                back: "–ù–∞–∑–∞–¥",
                progress: "–ü—Ä–æ–≥—Ä–µ—Å—Å",
                modules: "–º–æ–¥—É–ª–µ–π",
                courseModules: "–ú–æ–¥—É–ª–∏ –∫—É—Ä—Å–∞",
                theory: "–¢–µ–æ—Ä–∏—è",
                flashcards: "–§–ª–µ—à–∫–∞—Ä—Ç—ã",
                tests: "–¢–µ—Å—Ç—ã",
                practice: "–ü—Ä–∞–∫—Ç–∏–∫–∞",
                pages: "—Å—Ç—Ä",
                cards: "—à—Ç",
                tasks: "—à—Ç",
                completeModule: "–ó–∞–≤–µ—Ä—à–∏—Ç—å –º–æ–¥—É–ª—å",
                next: "–î–∞–ª–µ–µ",
                previous: "–ù–∞–∑–∞–¥",
                page: "–°—Ç—Ä–∞–Ω–∏—Ü–∞",
                of: "–∏–∑",
                flipCard: "–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏",
                testTasks: "–¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–¥–∞–Ω–∏—è",
                question: "–í–æ–ø—Ä–æ—Å",
                correct: "–ü—Ä–∞–≤–∏–ª—å–Ω–æ",
                incorrect: "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ",
                submitTest: "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç",
                testResults: "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞",
                excellent: "–û—Ç–ª–∏—á–Ω–æ! –ú–æ–¥—É–ª—å –ø—Ä–æ–π–¥–µ–Ω",
                tryAgain: "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞",
                yourAnswer: "–í–∞—à –æ—Ç–≤–µ—Ç",
                correctAnswer: "–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç",
                retakeTest: "–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ",
                practicalTask: "–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ",
                task: "–ó–∞–¥–∞–Ω–∏–µ",
                codeEditor: "–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞",
                runCode: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–¥",
                checkCode: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥",
                checking: "–ü—Ä–æ–≤–µ—Ä–∫–∞...",
                aiChecking: "–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à –∫–æ–¥...",
                greatCodeCorrect: "‚úì –û—Ç–ª–∏—á–Ω–æ! –ö–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π!",
                needsImprovement: "‚úó –¢—Ä–µ–±—É—é—Ç—Å—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
                errorsFound: "–ù–∞–π–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏",
                suggestions: "–°–æ–≤–µ—Ç—ã",
                expectedResult: "–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
                checkAnswer: "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç",
                writeSolution: "–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ –∑–¥–µ—Å—å...",
                instruction: "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
                certificate: "–í–∞—à —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç",
                certificatePreview: "–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–∏ –∫—É—Ä—Å–∞",
                downloadCertificate: "–°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç",
                enterName: "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è –¥–ª—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞:",
                congratulations: "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!",
                successfullyCompleted: "–≤—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∫—É—Ä—Å",
                certificateDownloaded: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –±—ã–ª —Å–∫–∞—á–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏",
                createNewCourse: "–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫—É—Ä—Å",
                downloadAgain: "–°–∫–∞—á–∞—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –µ—â–µ —Ä–∞–∑",
                viewAllCourses: "–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –∫—É—Ä—Å—ã",
                myCourses: "–ú–æ–∏ –∫—É—Ä—Å—ã",
                noCourses: "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—Å–æ–≤",
                deleteCourse: "–£–¥–∞–ª–∏—Ç—å –∫—É—Ä—Å",
                created: "–°–æ–∑–¥–∞–Ω",
                continueLearning: "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ"
            },
            kk: {
                createCourse: "–≠–ª–µ–∫—Ç—Ä–æ–Ω–¥—ã –∫—É—Ä—Å—Ç—ã –∂–∞—Å–∞“£—ã–∑",
                uploadDescription: "–ú–∏–∫—Ä–æ–æ“õ—ã—Ç—É–¥—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–ª–∞—É “Ø—à—ñ–Ω PDF-—Ñ–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ“£—ñ–∑",
                uploadPdf: "PDF-—Ñ–∞–π–ª–¥—ã –∂“Ø–∫—Ç–µ“£—ñ–∑",
                clickOrDrag: "–§–∞–π–ª–¥—ã –æ—Å—ã –∞–π–º–∞“õ“õ–∞ –±–∞—Å—ã“£—ã–∑ –Ω–µ–º–µ—Å–µ —Å“Ø–π—Ä–µ“£—ñ–∑",
                fileNotSelected: "–§–∞–π–ª —Ç–∞“£–¥–∞–ª–º–∞“ì–∞–Ω",
                createMicrolearning: "–ë–∞—Å—Ç–∞—É",
                toMainPage: "–ö—É—Ä—Å—Ç–∞—Ä –∫—ñ—Ç–∞–ø—Ö–∞–Ω–∞—Å—ã",
                toUploadPage: "–ñ–∞“£–∞ –∫—É—Ä—Å –∂–∞—Å–∞—É",
                generatingCourse: "–ö—É—Ä—Å –∂–∞—Å–∞–ª—É–¥–∞...",
                analyzingMaterial: "AI –º–∞—Ç–µ—Ä–∏–∞–ª–¥—ã —Ç–∞–ª–¥–∞–ø, –∫–æ–Ω—Ç–µ–Ω—Ç –∂–∞—Å–∞–π–¥—ã",
                mayTakeTime: "–ë—ñ—Ä–Ω–µ—à–µ –º–∏–Ω—É—Ç “õ–∞–ª—É—ã –º“Ø–º–∫—ñ–Ω",
                back: "–ê—Ä—Ç“õ–∞",
                progress: "–ü—Ä–æ–≥—Ä–µ—Å—Å",
                modules: "–º–æ–¥—É–ª—å",
                courseModules: "–ö—É—Ä—Å –º–æ–¥—É–ª—å–¥–µ—Ä—ñ",
                theory: "–¢–µ–æ—Ä–∏—è",
                flashcards: "–§–ª–µ—à–∫–∞—Ä—Ç–∞–ª–∞—Ä",
                tests: "–¢–µ—Å—Ç—Ç–µ—Ä",
                practice: "–ü—Ä–∞–∫—Ç–∏–∫–∞",
                pages: "–±–µ—Ç",
                cards: "–¥–∞–Ω–∞",
                tasks: "–¥–∞–Ω–∞",
                completeModule: "–ú–æ–¥—É–ª—å–¥—ñ –∞—è“õ—Ç–∞—É",
                next: "–ö–µ–ª–µ—Å—ñ",
                previous: "–ê–ª–¥—ã“£“ì—ã",
                page: "–ë–µ—Ç",
                of: "—ñ—à—ñ–Ω–µ–Ω",
                flipCard: "–ö–∞—Ä—Ç–∞–Ω—ã –∞—É–¥–∞—Ä—É “Ø—à—ñ–Ω –±–∞—Å—ã“£—ã–∑",
                testTasks: "–¢–µ—Å—Ç—Ç—ñ–∫ —Ç–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä",
                question: "–°“±—Ä–∞“õ",
                correct: "–î“±—Ä—ã—Å",
                incorrect: "“ö–∞—Ç–µ",
                submitTest: "–¢–µ—Å—Ç—Ç—ñ –∞—è“õ—Ç–∞—É",
                testResults: "–¢–µ—Å—Ç –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ",
                excellent: "–¢–∞–º–∞—à–∞! –ú–æ–¥—É–ª—å ”©—Ç—ñ–ª–¥—ñ",
                tryAgain: "–ñ–∞“õ—Å—ã –Ω”ô—Ç–∏–∂–µ “Ø—à—ñ–Ω “õ–∞–π—Ç–∞–¥–∞–Ω –∫”©—Ä—ñ“£—ñ–∑",
                yourAnswer: "–°—ñ–∑–¥—ñ“£ –∂–∞—É–∞–±—ã“£—ã–∑",
                correctAnswer: "–î“±—Ä—ã—Å –∂–∞—É–∞–ø",
                retakeTest: "“ö–∞–π—Ç–∞ ”©—Ç—É",
                practicalTask: "–ü—Ä–∞–∫—Ç–∏–∫–∞–ª—ã“õ —Ç–∞–ø—Å—ã—Ä–º–∞",
                task: "–¢–∞–ø—Å—ã—Ä–º–∞",
                codeEditor: "–ö–æ–¥ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã",
                runCode: "–ö–æ–¥—Ç—ã —ñ—Å–∫–µ “õ–æ—Å—É",
                checkCode: "–ö–æ–¥—Ç—ã —Ç–µ–∫—Å–µ—Ä—É",
                checking: "–¢–µ–∫—Å–µ—Ä—É...",
                aiChecking: "AI —Å—ñ–∑–¥—ñ“£ –∫–æ–¥—ã“£—ã–∑–¥—ã —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ",
                greatCodeCorrect: "‚úì –¢–∞–º–∞—à–∞! –ö–æ–¥ –¥“±—Ä—ã—Å!",
                needsImprovement: "‚úó –ñ–µ—Ç—ñ–ª–¥—ñ—Ä—É “õ–∞–∂–µ—Ç",
                errorsFound: "–¢–∞–±—ã–ª“ì–∞–Ω “õ–∞—Ç–µ–ª–µ—Ä",
                suggestions: "–ö–µ“£–µ—Å—Ç–µ—Ä",
                expectedResult: "–ö“Ø—Ç—ñ–ª–µ—Ç—ñ–Ω –Ω”ô—Ç–∏–∂–µ",
                checkAnswer: "–ñ–∞—É–∞–ø—Ç—ã —Ç–µ–∫—Å–µ—Ä—É",
                writeSolution: "–®–µ—à—ñ–º—ñ“£—ñ–∑–¥—ñ –æ—Å—ã –∂–µ—Ä–≥–µ –∂–∞–∑—ã“£—ã–∑...",
                instruction: "–ù“±—Å“õ–∞—É–ª—ã“õ",
                certificate: "–°—ñ–∑–¥—ñ“£ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã“£—ã–∑",
                certificatePreview: "–ö—É—Ä—Å—Ç—ã –∞—è“õ—Ç–∞—É —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã–Ω—ã“£ –∞–ª–¥—ã–Ω –∞–ª–∞ “õ–∞—Ä–∞—É—ã",
                downloadCertificate: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã –∂“Ø–∫—Ç–µ—É",
                enterName: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç “Ø—à—ñ–Ω –∞—Ç—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑:",
                congratulations: "“ö“±—Ç—Ç—ã“õ—Ç–∞–π–º—ã–∑!",
                successfullyCompleted: "–°—ñ–∑ –∫—É—Ä—Å—Ç—ã —Å”ô—Ç—Ç—ñ –∞—è“õ—Ç–∞–¥—ã“£—ã–∑",
                certificateDownloaded: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∂“Ø–∫—Ç–µ–ª–¥—ñ",
                createNewCourse: "–ñ–∞“£–∞ –∫—É—Ä—Å –∂–∞—Å–∞—É",
                downloadAgain: "–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã “õ–∞–π—Ç–∞ –∂“Ø–∫—Ç–µ—É",
                viewAllCourses: "–ë–∞—Ä–ª—ã“õ –∫—É—Ä—Å–∞—Ä–¥—ã “õ–∞—Ä–∞—É",
                myCourses: "–ú–µ–Ω—ñ“£ –∫—É—Ä—Å—Ç–∞—Ä—ã–º",
                noCourses: "–°—ñ–∑–¥–µ ”ô–ª—ñ –∫—É—Ä—Å—Ç–∞—Ä –∂–æ“õ",
                deleteCourse: "–ö—É—Ä—Å—Ç—ã –∂–æ—é",
                created: "–ñ–∞—Å–∞–ª“ì–∞–Ω",
                continueLearning: "–û“õ—É–¥—ã –∂–∞–ª“ì–∞—Å—Ç—ã—Ä—É"
            }
        };

        let currentLang = localStorage.getItem('ai-ustaz_lang') || 'ru';

        function t(key) {
            return translations[currentLang][key] || key;
        }

        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        function initApp() {
            console.log('Initializing Ai-Ustaz app...');
            loadCourses();
            loadTheme(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
            checkAPIStatus();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞ –≥–ª–∞–≤–Ω—É—é"
            const savedLang = localStorage.getItem('ai-ustaz_lang') || 'ru';
            const homeBtn = document.querySelector('.home-btn-text');
            if (homeBtn) {
                homeBtn.textContent = homeBtn.getAttribute(`data-${savedLang}`);
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('id');
            
            if (courseId) {
                loadCourse(parseInt(courseId));
            } else {
                render();
            }
        }

        // ==================== –•–†–ê–ù–ò–õ–ò–©–ï ====================
        function loadCourses() {
            try {
                const saved = localStorage.getItem('ai-ustaz_courses');
                if (saved) {
                    state.courses = JSON.parse(saved);
                    console.log('Loaded courses:', state.courses.length);
                }
            } catch (error) {
                console.error('Error loading courses:', error);
                state.courses = [];
            }
        }

        function saveCourses() {
            try {
                localStorage.setItem('ai-ustaz_courses', JSON.stringify(state.courses));
            } catch (error) {
                console.error('Error saving courses:', error);
            }
        }

        function saveCourse(courseData) {
            const course = {
                id: Date.now(),
                title: courseData.title,
                createdAt: new Date().toISOString(),
                microlearning: courseData.microlearning,
                completedModules: {
                    theory: false,
                    flashcards: false,
                    textQuiz: false,
                    practicalQuiz: false
                },
                completedTasks: {
                    textQuiz: [],
                    practicalQuiz: []
                },
                viewedPages: {
                    theory: [],
                    flashcards: []
                }
            };
            state.courses.push(course);
            saveCourses();
            return course;
        }
        
        function markPageViewed(moduleType, pageIndex) {
            if (!state.currentCourse) return;
            
            if (!state.currentCourse.viewedPages) {
                state.currentCourse.viewedPages = {
                    theory: [],
                    flashcards: []
                };
            }
            
            if (!state.currentCourse.viewedPages[moduleType].includes(pageIndex)) {
                state.currentCourse.viewedPages[moduleType].push(pageIndex);
                
                const courseIndex = state.courses.findIndex(c => c.id === state.currentCourse.id);
                if (courseIndex !== -1) {
                    state.courses[courseIndex] = state.currentCourse;
                    saveCourses();
                }
            }
        }
        
        function isAllPagesViewed(moduleType) {
            if (!state.currentCourse || !state.currentCourse.microlearning[moduleType]) return false;
            
            const totalPages = state.currentCourse.microlearning[moduleType].length;
            const viewedPages = state.currentCourse.viewedPages?.[moduleType]?.length || 0;
            
            return viewedPages === totalPages;
        }
        
        function markTaskCompleted(moduleType, taskIndex) {
            if (!state.currentCourse) return;
            
            if (!state.currentCourse.completedTasks) {
                state.currentCourse.completedTasks = {
                    textQuiz: [],
                    practicalQuiz: []
                };
            }
            
            if (!state.currentCourse.completedTasks[moduleType].includes(taskIndex)) {
                state.currentCourse.completedTasks[moduleType].push(taskIndex);
                
                const courseIndex = state.courses.findIndex(c => c.id === state.currentCourse.id);
                if (courseIndex !== -1) {
                    state.courses[courseIndex] = state.currentCourse;
                    saveCourses();
                }
            }
        }
        
        function isAllTasksCompleted(moduleType) {
            if (!state.currentCourse || !state.currentCourse.microlearning[moduleType]) return false;
            
            const totalTasks = state.currentCourse.microlearning[moduleType].length;
            const completedTasks = state.currentCourse.completedTasks?.[moduleType]?.length || 0;
            
            return completedTasks === totalTasks;
        }

        function deleteCourse(courseId) {
            if (confirm(currentLang === 'ru' ? '–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫—É—Ä—Å?' : '–ë“±–ª –∫—É—Ä—Å –∂–æ–π—ã–ª—Å—ã–Ω –±–∞?')) {
                state.courses = state.courses.filter(c => c.id !== courseId);
                saveCourses();
                render();
            }
        }

        function loadCourse(courseId) {
            const course = state.courses.find(c => c.id === courseId);
            if (course) {
                if (course.microlearning && course.microlearning.textQuiz) {
                    course.microlearning.textQuiz = validateAndFixQuestions(course.microlearning.textQuiz);
                }
                
                state.currentCourse = course;
                state.completedModules = course.completedModules;
                state.currentModule = 'theory';
                state.step = 'learning';
                state.lockedQuestions.clear();
                render();
            }
        }

        function updateCourseProgress() {
            if (state.currentCourse) {
                const course = state.courses.find(c => c.id === state.currentCourse.id);
                if (course) {
                    course.completedModules = {...state.completedModules};
                    saveCourses();
                }
            }
        }

        // ==================== API –ò –ü–†–û–í–ï–†–ö–ò ====================
        async function checkAPIStatus() {
            try {
                const response = await fetch('/api/check-api');
                const data = await response.json();
                
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    if (data.api_key_configured) {
                        statusElement.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>API: ${data.api_working ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ –æ—Ç–≤–µ—á–∞–µ—Ç'}`;
                    } else {
                        statusElement.innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>API –∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω`;
                    }
                }
                
                return data;
            } catch (error) {
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.innerHTML = `<i class="fas fa-times-circle text-red-500 mr-2"></i>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è`;
                }
                console.error('API check failed:', error);
                return null;
            }
        }

        // ==================== PDF –û–ë–†–ê–ë–û–¢–ö–ê ====================
        async function extractTextFromPDF(file) {
            try {
                console.log('Extracting text from PDF...');
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                console.log('PDF text extracted, length:', fullText.length);
                return fullText;
            } catch (error) {
                console.error('PDF extraction error:', error);
                throw new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è PDF —Ñ–∞–π–ª–∞');
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                state.pdfFile = file;
                document.getElementById('file-name').textContent = file.name;
                document.getElementById('generate-btn').disabled = false;
            } else {
                alert(currentLang === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª' : 'PDF —Ñ–∞–π–ª–¥—ã —Ç–∞“£–¥–∞“£—ã–∑');
            }
        }

        async function generateMicrolearning() {
            if (!state.pdfFile) {
                alert(currentLang === 'ru' ? '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ PDF —Ñ–∞–π–ª' : '–ê–ª–¥—ã–º–µ–Ω PDF —Ñ–∞–π–ª–¥—ã —Ç–∞“£–¥–∞“£—ã–∑');
                return;
            }
            
            state.step = 'generating';
            render();
            
            try {
                const pdfText = await extractTextFromPDF(state.pdfFile);
                
                const response = await fetch('/api/generate-microlearning', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        pdf_text: pdfText,
                        pdf_name: state.pdfFile.name
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.microlearning.textQuiz && data.microlearning.textQuiz.length < 10) {
                        console.warn(`–°–æ–∑–¥–∞–Ω–æ —Ç–æ–ª—å–∫–æ ${data.microlearning.textQuiz.length} –≤–æ–ø—Ä–æ—Å–æ–≤, —Ç—Ä–µ–±—É–µ—Ç—Å—è –º–∏–Ω–∏–º—É–º 10`);
                    }
                    
                    const course = saveCourse({
                        title: data.title,
                        microlearning: data.microlearning
                    });
                    
                    state.currentCourse = course;
                    state.completedModules = course.completedModules;
                    state.currentModule = 'theory';
                    state.step = 'learning';
                    render();
                } else {
                    alert((currentLang === 'ru' ? '–û—à–∏–±–∫–∞: ' : '“ö–∞—Ç–µ: ') + data.error);
                    state.step = 'upload';
                    render();
                }
            } catch (error) {
                console.error('Generation error:', error);
                alert(currentLang === 'ru' ? '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫—É—Ä—Å–∞' : '–ö—É—Ä—Å—Ç—ã –∂–∞—Å–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã');
                state.step = 'upload';
                render();
            }
        }

        // ==================== –ù–ê–í–ò–ì–ê–¶–ò–Ø ====================
        function showMainPage() {
            state.step = 'main';
            render();
        }

        function openModule(moduleName) {
            state.currentModule = moduleName;
            state.currentTheoryPage = 0;
            state.currentCardIndex = 0;
            state.currentQuestionIndex = 0;
            state.quizAnswers = [];
            state.quizResults = null;
            state.practicalCode = '';
            state.practicalOutput = '';
            state.practicalCheckResult = null;
            state.checkingAnswer = false;
            state.lockedQuestions.clear();
            render();
        }

        function completeModule() {
            if (state.currentModule) {
                state.completedModules[state.currentModule] = true;
                updateCourseProgress();
                
                const modules = ['theory', 'flashcards', 'textQuiz', 'practicalQuiz'];
                const currentIndex = modules.indexOf(state.currentModule);
                
                const allCompleted = modules.every(module => state.completedModules[module]);
                
                if (allCompleted) {
                    setTimeout(() => {
                        generateCertificate();
                    }, 1000);
                } else if (currentIndex < modules.length - 1) {
                    setTimeout(() => {
                        openModule(modules[currentIndex + 1]);
                    }, 1000);
                }
            }
        }

        function backToHome() {
            state.step = 'upload';
            state.currentCourse = null;
            render();
        }

        // ==================== –°–ï–†–¢–ò–§–ò–ö–ê–¢ ====================
        function generateCertificate() {
            const studentName = prompt(t('enterName'));
            if (!studentName) return;
            
            const courseTitle = state.currentCourse.title;
            const hasKazakhChars = /[”ô“ì“õ“£”©“±“Ø—ñ“ª”ò“í“ö“¢”®“∞“Æ–Ü“∫]/.test(courseTitle);
            const language = hasKazakhChars ? 'kz' : 'ru';
            
            const completionDate = new Date().toLocaleDateString('ru-RU');
            
            state.certificateData = {
                studentName,
                courseTitle,
                completionDate,
                language
            };
            
            showCertificatePreview();
        }

        function showCertificatePreview() {
            const app = document.getElementById('app');
            if (!app) return;
            
            const data = state.certificateData;
            
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-8">
                    <div class="max-w-4xl w-full fade-in">
                        <button onclick="backToLearning()" class="btn-secondary mb-6">
                            <i class="fas fa-arrow-left mr-2"></i>${t('back')}
                        </button>

                        <div class="glass-card p-8">
                            <div class="text-center mb-8">
                                <h1 class="text-4xl font-bold mb-2 text-gray-800">${t('certificate')}</h1>
                                <p class="text-gray-600">${t('certificatePreview')}</p>
                            </div>

                            <div class="certificate-preview">
                                <div class="certificate-border"></div>
                                <div class="certificate-content">
                                    <div class="university-name">
                                        ${data.language === 'kz' 
                                            ? '–°”ò–†–°–ï–ù –ê–ú–ê–ù–ñ–û–õ–û–í –ê–¢–´–ù–î–ê“í–´ –®–´“í–´–° “ö–ê–ó–ê“ö–°–¢–ê–ù –£–ù–ò–í–ï–†–°–ò–¢–ï–¢–Ü'
                                            : '–í–û–°–¢–û–ß–ù–û-–ö–ê–ó–ê–•–°–¢–ê–ù–°–ö–ò–ô –£–ù–ò–í–ï–†–°–ò–¢–ï–¢ –ò–ú–ï–ù–ò –°–ê–†–°–ï–ù–ê –ê–ú–ê–ù–ñ–û–õ–û–í–ê'
                                        }
                                    </div>
                                    
                                    <div class="certificate-title">–°–ï–†–¢–ò–§–ò–ö–ê–¢</div>
                                    
                                    <div class="text-gray-600 mb-4">
                                        ${data.language === 'kz'
                                            ? '–û—Å—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç'
                                            : '–ù–∞—Å—Ç–æ—è—â–∏–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç, —á—Ç–æ'
                                        }
                                    </div>
                                    
                                    <div class="student-name">${data.studentName.toUpperCase()}</div>
                                    
                                    <div class="text-gray-600 mb-4">
                                        ${data.language === 'kz'
                                            ? `¬´${data.courseTitle}¬ª –∫—É—Ä—Å—ã–Ω –∞—è“õ—Ç–∞–ø, –æ“õ—ã—Ç—É –±–∞“ì–¥–∞—Ä–ª–∞–º–∞—Å—ã–Ω–¥–∞ “õ–∞—Ä–∞—Å—Ç—ã—Ä—ã–ª“ì–∞–Ω –±–∞—Ä–ª—ã“õ –º–∞—Ç–µ—Ä–∏–∞–ª–¥–∞—Ä–¥—ã –º–µ“£–≥–µ—Ä–≥–µ–Ω—ñ–Ω —Ä–∞—Å—Ç–∞–π–¥—ã.`
                                            : `–∑–∞–≤–µ—Ä—à–∏–ª–∞ –∫—É—Ä—Å ¬´${data.courseTitle}¬ª –∏ –æ—Å–≤–æ–∏–ª–∞ –≤—Å–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ —É—á–µ–±–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª—ã.`
                                        }
                                    </div>
                                    
                                    <div class="completion-date">${data.completionDate}</div>
                                    
                                    <div class="signatures">
                                        <div class="signature">
                                            _________________________<br>
                                            ${data.language === 'kz' 
                                                ? '–ë–∞—Å“õ–∞—Ä–º–∞ —Ç”©—Ä–∞“ì–∞—Å—ã-—Ä–µ–∫—Ç–æ—Ä, –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –¢”©–ª–µ–≥–µ–Ω –ú.”ò.'
                                                : '–ü—Ä–µ–¥—Å–µ–¥–∞—Ç–µ–ª—å –ø—Ä–∞–≤–ª–µ–Ω–∏—è-—Ä–µ–∫—Ç–æ—Ä, –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä –¢”©–ª–µ–≥–µ–Ω –ú.”ò.'
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mt-8">
                                <button onclick="downloadCertificate()" class="btn-primary mr-4">
                                    <i class="fas fa-download mr-2"></i>${t('downloadCertificate')}
                                </button>
                                <button onclick="backToLearning()" class="btn-secondary">
                                    <i class="fas fa-arrow-left mr-2"></i>${t('back')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function downloadCertificate() {
            const data = state.certificateData;
            
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-8">
                    <div class="glass-card p-12 text-center max-w-md fade-in">
                        <div class="spinner mx-auto mb-6"></div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">${t('generatingCourse')}</h2>
                        <p class="text-gray-600">${currentLang === 'ru' 
                            ? '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç –í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –∏–º–µ–Ω–∏ –°–∞—Ä—Å–µ–Ω–∞ –ê–º–∞–Ω–∂–æ–ª–æ–≤–∞' 
                            : '–°”ô—Ä—Å–µ–Ω –ê–º–∞–Ω–∂–æ–ª–æ–≤ –∞—Ç—ã–Ω–¥–∞“ì—ã –®—ã“ì—ã—Å “ö–∞–∑–∞“õ—Å—Ç–∞–Ω —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ–Ω—ñ“£ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã'}</p>
                    </div>
                </div>
            `;
            
            fetch('/api/generate-certificate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    student_name: data.studentName,
                    course_title: data.courseTitle,
                    completion_date: data.completionDate,
                    language: data.language
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.blob();
                }
                throw new Error(currentLang === 'ru' ? '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞' : '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–ª–∞—É “õ–∞—Ç–µ—Å—ñ');
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${currentLang === 'ru' ? '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç' : '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç'}_${data.studentName}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
                showCongratulations(data.studentName);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert(currentLang === 'ru' 
                    ? '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞' 
                    : '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏—è–ª–∞—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã');
                showCertificatePreview();
            });
        }

        function backToLearning() {
            state.step = 'learning';
            render();
        }

        function showCongratulations(studentName) {
            const app = document.getElementById('app');
            if (!app) return;
            
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-8 bg-gradient-to-br from-green-400 to-blue-500">
                    <div class="glass-card p-12 text-center max-w-2xl fade-in">
                        <div class="icon-large text-green-500">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h1 class="text-4xl font-bold mb-6 text-gray-800">${t('congratulations')}</h1>
                        <p class="text-xl text-gray-600 mb-6">
                            <strong>${studentName}</strong>, ${t('successfullyCompleted')}<br>
                            "<strong>${state.currentCourse.title}</strong>"
                        </p>
                        <p class="text-gray-500 mb-8">
                            ${currentLang === 'ru' 
                                ? '–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ—Ç –í–æ—Å—Ç–æ—á–Ω–æ-–ö–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–æ–≥–æ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ –∏–º–µ–Ω–∏ –°–∞—Ä—Å–µ–Ω–∞ –ê–º–∞–Ω–∂–æ–ª–æ–≤–∞<br>–±—ã–ª —Å–∫–∞—á–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.'
                                : '–°”ô—Ä—Å–µ–Ω –ê–º–∞–Ω–∂–æ–ª–æ–≤ –∞—Ç—ã–Ω–¥–∞“ì—ã –®—ã“ì—ã—Å “ö–∞–∑–∞“õ—Å—Ç–∞–Ω —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç—ñ–Ω—ñ“£ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã<br>–∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –∂“Ø–∫—Ç–µ–ª–¥—ñ.'}
                        </p>
                        <div class="space-y-4">
                            <button onclick="showMainPage()" class="btn-primary">
                                <i class="fas fa-book mr-2"></i>${t('myCourses')}
                            </button>
                            <br>
                            <button onclick="backToHome()" class="btn-secondary mr-2">
                                <i class="fas fa-plus mr-2"></i>${t('createNewCourse')}
                            </button>
                            <button onclick="generateCertificate()" class="btn-secondary">
                                <i class="fas fa-download mr-2"></i>${t('downloadAgain')}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==================== –¢–ï–û–†–ò–Ø ====================
        function nextTheoryPage() {
            const pages = state.currentCourse.microlearning.theory;
            markPageViewed('theory', state.currentTheoryPage);
            
            if (state.currentTheoryPage < pages.length - 1) {
                state.currentTheoryPage++;
                render();
            }
        }

        function prevTheoryPage() {
            if (state.currentTheoryPage > 0) {
                markPageViewed('theory', state.currentTheoryPage);
                state.currentTheoryPage--;
                render();
            }
        }

        // ==================== –§–õ–ï–®–ö–ê–†–¢–´ ====================
        function flipCard() {
            const flashcard = document.querySelector('.flashcard');
            if (flashcard) {
                flashcard.classList.toggle('flipped');
            }
        }

        function nextCard() {
            const cards = state.currentCourse.microlearning.flashcards;
            markPageViewed('flashcards', state.currentCardIndex);
            
            if (state.currentCardIndex < cards.length - 1) {
                state.currentCardIndex++;
                const flashcard = document.querySelector('.flashcard');
                if (flashcard && flashcard.classList.contains('flipped')) {
                    flashcard.classList.remove('flipped');
                }
                render();
            }
        }

        function prevCard() {
            if (state.currentCardIndex > 0) {
                markPageViewed('flashcards', state.currentCardIndex);
                state.currentCardIndex--;
                const flashcard = document.querySelector('.flashcard');
                if (flashcard && flashcard.classList.contains('flipped')) {
                    flashcard.classList.remove('flipped');
                }
                render();
            }
        }

        // ==================== –¢–ï–°–¢–û–í–´–ï –ó–ê–î–ê–ù–ò–Ø ====================
        function selectAnswer(questionIndex, answerIndex) {
            if (!state.lockedQuestions.has(questionIndex)) {
                state.quizAnswers[questionIndex] = answerIndex;
                render();
            }
            return false;
        }

        function nextQuestion() {
            const questions = state.currentCourse.microlearning.textQuiz;
            
            if (state.quizAnswers[state.currentQuestionIndex] === undefined) {
                alert(currentLang === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ—Ç–≤–µ—Ç' : '–ñ–∞—É–∞–ø—Ç—ã —Ç–∞“£–¥–∞“£—ã–∑');
                return;
            }
            
            state.lockedQuestions.add(state.currentQuestionIndex);
            
            if (state.currentQuestionIndex < questions.length - 1) {
                state.currentQuestionIndex++;
                render();
            }
        }

        function prevQuestion() {
            if (state.currentQuestionIndex > 0) {
                state.currentQuestionIndex--;
                render();
            }
        }

        function submitTextQuiz() {
            const questions = state.currentCourse.microlearning.textQuiz;
            
            for (let i = 0; i < questions.length; i++) {
                if (state.quizAnswers[i] === undefined || 
                    (questions[i].type === 'short_answer' && (!state.quizAnswers[i] || state.quizAnswers[i].trim().length === 0))) {
                    alert(currentLang === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã' : '–ë–∞—Ä–ª—ã“õ —Å“±—Ä–∞“õ—Ç–∞—Ä“ì–∞ –∂–∞—É–∞–ø –±–µ—Ä—ñ“£—ñ–∑');
                    state.currentQuestionIndex = i;
                    render();
                    return;
                }
            }
            
            for (let i = 0; i < questions.length; i++) {
                state.lockedQuestions.add(i);
            }
            
            const results = questions.map((q, i) => {
                const userAnswer = state.quizAnswers[i];
                let isCorrect = false;
                
                if (q.type === 'multiple_choice') {
                    isCorrect = userAnswer === q.correctAnswer || userAnswer === q.correct_answer;
                } else if (q.type === 'true_false') {
                    const correctAnswer = q.correctAnswer !== undefined ? q.correctAnswer : q.correct_answer;
                    isCorrect = userAnswer === (correctAnswer ? 0 : 1);
                } else if (q.type === 'short_answer') {
                    isCorrect = true;
                }
                
                return {
                    question: q.question,
                    userAnswer: userAnswer,
                    correctAnswer: q.correctAnswer !== undefined ? q.correctAnswer : q.correct_answer,
                    isCorrect: isCorrect,
                    explanation: q.explanation,
                    type: q.type,
                    options: q.options
                };
            });
            
            state.quizResults = results;
            
            for (let i = 0; i < questions.length; i++) {
                markTaskCompleted('textQuiz', i);
            }
            
            const correct = results.filter(r => r.isCorrect).length;
            const percentage = Math.round((correct / results.length) * 100);
            
            if (percentage >= 70) {
                completeModule();
            }
            
            render();
        }

        function validateAndFixQuestions(questions) {
            if (!questions || !Array.isArray(questions)) return questions;
            
            return questions.map((q, index) => {
                const fixedQuestion = {...q};
                
                if (fixedQuestion.type === 'multiple_choice' && 
                    (!fixedQuestion.options || !Array.isArray(fixedQuestion.options) || fixedQuestion.options.length === 0)) {
                    
                    console.warn(`üîÑ –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å ${index}: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç options`);
                    fixedQuestion.options = [
                        currentLang === 'ru' ? "–î–∞, —ç—Ç–æ –≤–µ—Ä–Ω–æ" : "–ò—è, –±“±–ª –¥“±—Ä—ã—Å",
                        currentLang === 'ru' ? "–ù–µ—Ç, —ç—Ç–æ –Ω–µ–≤–µ—Ä–Ω–æ" : "–ñ–æ“õ, –±“±–ª –¥“±—Ä—ã—Å –µ–º–µ—Å", 
                        currentLang === 'ru' ? "–ß–∞—Å—Ç–∏—á–Ω–æ –≤–µ—Ä–Ω–æ" : "–Ü—à—ñ–Ω–∞—Ä–∞ –¥“±—Ä—ã—Å",
                        currentLang === 'ru' ? "–ó–∞—Ç—Ä—É–¥–Ω—è—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å" : "–ñ–∞—É–∞–ø –±–µ—Ä—É “õ–∏—ã–Ω"
                    ];
                    
                    if (fixedQuestion.correctAnswer === undefined && fixedQuestion.correct_answer === undefined) {
                        fixedQuestion.correctAnswer = 0;
                    }
                }
                
                if (fixedQuestion.type === 'true_false' && 
                    (!fixedQuestion.options || !Array.isArray(fixedQuestion.options) || fixedQuestion.options.length === 0)) {
                    
                    fixedQuestion.options = [
                        currentLang === 'ru' ? "–í–µ—Ä–Ω–æ" : "–î“±—Ä—ã—Å", 
                        currentLang === 'ru' ? "–ù–µ–≤–µ—Ä–Ω–æ" : "“ö–∞—Ç–µ"
                    ];
                }
                
                if (fixedQuestion.correct_answer !== undefined && fixedQuestion.correctAnswer === undefined) {
                    fixedQuestion.correctAnswer = fixedQuestion.correct_answer;
                }
                
                return fixedQuestion;
            });
        }

        function canProceedToNext() {
            const q = state.currentCourse.microlearning.textQuiz[state.currentQuestionIndex];
            
            if (q.type === 'multiple_choice' || q.type === 'true_false') {
                return state.quizAnswers[state.currentQuestionIndex] !== undefined;
            }
            
            if (q.type === 'short_answer') {
                return state.quizAnswers[state.currentQuestionIndex] && 
                       state.quizAnswers[state.currentQuestionIndex].trim().length > 0;
            }
            
            return true;
        }

        function updateShortAnswer(questionIndex, value) {
            state.quizAnswers[questionIndex] = value;
            // –ù–µ –≤—ã–∑—ã–≤–∞–µ–º render() —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Ñ–æ–∫—É—Å –ø—Ä–∏ –≤–≤–æ–¥–µ
        }

        async function checkShortAnswer() {
            const currentQ = state.currentCourse.microlearning.textQuiz[state.currentQuestionIndex];
            const userAnswer = state.quizAnswers[state.currentQuestionIndex];
            
            if (!userAnswer || userAnswer.trim().length === 0) {
                alert(currentLang === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç' : '–ñ–∞—É–∞–ø—Ç—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑');
                return;
            }
            
            state.checkingShortAnswer = true;
            render();
            
            try {
                const response = await fetch('/api/check-short-answer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: currentQ.question,
                        user_answer: userAnswer,
                        expected_answer: currentQ.expectedAnswer || currentQ.expected_answer || '',
                        language: currentLang
                    })
                });
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–≤–µ—Ç–∞');
                }
                
                const result = await response.json();
                
                state.aiCheckResults[state.currentQuestionIndex] = {
                    isCorrect: result.is_correct,
                    feedback: result.feedback,
                    score: result.score
                };
                
                state.checkingShortAnswer = false;
                render();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', error);
                alert(currentLang === 'ru' 
                    ? '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –æ—Ç–≤–µ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.' 
                    : '–ñ–∞—É–∞–ø—Ç—ã —Ç–µ–∫—Å–µ—Ä—É –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã. “ö–∞–π—Ç–∞–¥–∞–Ω –∫”©—Ä—ñ“£—ñ–∑.');
                state.checkingShortAnswer = false;
                render();
            }
        }

        // ==================== –ü–†–ê–ö–¢–ò–ß–ï–°–ö–ò–ï –ó–ê–î–ê–ù–ò–Ø ====================
        function updatePracticalCode(value) {
            state.practicalCode = value;
        }

        function nextPractical() {
            const tasks = state.currentCourse.microlearning.practicalQuiz;
            if (state.currentQuestionIndex < tasks.length - 1) {
                state.currentQuestionIndex++;
                state.practicalCode = '';
                state.practicalOutput = '';
                state.practicalCheckResult = null;
                state.checkingAnswer = false;
                render();
            }
        }

        function prevPractical() {
            if (state.currentQuestionIndex > 0) {
                state.currentQuestionIndex--;
                state.practicalCode = '';
                state.practicalOutput = '';
                state.practicalCheckResult = null;
                state.checkingAnswer = false;
                render();
            }
        }

        function checkPracticalAnswer() {
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞—á–∞—Ç–∞');
            const task = state.currentCourse.microlearning.practicalQuiz[state.currentQuestionIndex];
            const userAnswer = state.practicalCode || '';
            
            console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', userAnswer);
            
            if (!userAnswer.trim()) {
                alert(currentLang === 'ru' ? '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç' : '–ñ–∞—É–∞–±—ã“£—ã–∑–¥—ã –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑');
                return;
            }
            
            state.checkingAnswer = true;
            render();
            
            const endpoint = task.type === 'code' ? '/api/check-code' : '/api/check-practical-answer';
            const requestBody = task.type === 'code' ? {
                user_code: userAnswer,
                task: task.task,
                language: task.language || 'python',
                expected_output: task.solution || ''
            } : {
                task: task.task,
                instructions: task.instructions || '',
                user_answer: userAnswer
            };
            
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                console.log('–û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('–î–∞–Ω–Ω—ã–µ:', data);
                state.checkingAnswer = false;
                
                if (data.success) {
                    if (task.type === 'code') {
                        state.practicalCheckResult = {
                            isCorrect: data.result.correct,
                            feedback: data.result.feedback,
                            errors: data.result.errors || [],
                            suggestions: data.result.suggestions || [],
                            result_preview: data.result.result_preview || ''
                        };
                    } else {
                        state.practicalCheckResult = {
                            isCorrect: data.is_correct,
                            feedback: data.feedback
                        };
                    }
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:', state.practicalCheckResult.isCorrect);
                    
                    if (state.practicalCheckResult.isCorrect) {
                        markTaskCompleted('practicalQuiz', state.currentQuestionIndex);
                    }
                } else {
                    state.practicalCheckResult = {
                        isCorrect: false,
                        feedback: (currentLang === 'ru' ? '–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ' : '–¢–µ–∫—Å–µ—Ä—É “õ–∞—Ç–µ—Å—ñ: ') + data.error
                    };
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:', data.error);
                }
                
                render();
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
                state.checkingAnswer = false;
                state.practicalCheckResult = {
                    isCorrect: false,
                    feedback: (currentLang === 'ru' ? '–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' : '–°–µ—Ä–≤–µ—Ä–º–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å “õ–∞—Ç–µ—Å—ñ: ') + error.message
                };
                render();
            });
        }

        function runCode() {
            const task = state.currentCourse.microlearning.practicalQuiz[state.currentQuestionIndex];
            const code = state.practicalCode || task.initialCode;
            
            try {
                const existingOutput = document.querySelector('.code-output');
                if (existingOutput) {
                    existingOutput.remove();
                }
                
                if (code.includes('<!DOCTYPE') || code.includes('<html') || code.includes('<body')) {
                    const iframe = document.createElement('iframe');
                    iframe.style.width = '100%';
                    iframe.style.height = '500px';
                    iframe.style.border = '2px solid #e2e8f0';
                    iframe.style.borderRadius = '12px';
                    iframe.style.marginTop = '24px';
                    iframe.style.marginBottom = '24px';
                    iframe.style.background = 'white';
                    iframe.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                    
                    const header = document.createElement('div');
                    header.style.marginTop = '24px';
                    header.style.marginBottom = '12px';
                    header.style.display = 'flex';
                    header.style.alignItems = 'center';
                    header.style.gap = '8px';
                    header.innerHTML = `<span style="font-weight: 600; color: #2d3748; font-size: 14px;">${currentLang === 'ru' ? '–†–µ–∑—É–ª—å—Ç–∞—Ç:' : '–ù”ô—Ç–∏–∂–µ:'}</span><span style="color: #10b981; font-size: 14px;">‚úì ${currentLang === 'ru' ? 'HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞' : 'HTML –±–µ—Ç—ñ –∫”©—Ä—Å–µ—Ç—ñ–ª–¥—ñ'}</span>`;
                    
                    const outputContainer = document.createElement('div');
                    outputContainer.className = 'code-output';
                    outputContainer.appendChild(header);
                    outputContainer.appendChild(iframe);
                    
                    const runButton = document.querySelector('button[onclick="runCode()"]');
                    if (runButton) {
                        runButton.parentNode.insertBefore(outputContainer, runButton.nextSibling);
                    }
                    
                    setTimeout(() => {
                        try {
                            iframe.contentDocument.open();
                            iframe.contentDocument.write(code);
                            iframe.contentDocument.close();
                        } catch (error) {
                            header.innerHTML = `<span style="font-weight: 600; color: #2d3748; font-size: 14px;">${currentLang === 'ru' ? '–†–µ–∑—É–ª—å—Ç–∞—Ç:' : '–ù”ô—Ç–∏–∂–µ:'}</span><span style="color: #ef4444; font-size: 14px;">‚úó ${currentLang === 'ru' ? '–û—à–∏–±–∫–∞: ' : '“ö–∞—Ç–µ: '}${error.message}</span>`;
                        }
                    }, 100);
                    
                    return;
                } else {
                    const result = eval(code);
                    state.practicalOutput = `${currentLang === 'ru' ? '–†–µ–∑—É–ª—å—Ç–∞—Ç: ' : '–ù”ô—Ç–∏–∂–µ: '}${result !== undefined ? result : (currentLang === 'ru' ? '–ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ' : '–ö–æ–¥ —Å”ô—Ç—Ç—ñ –æ—Ä—ã–Ω–¥–∞–ª–¥—ã')}`;
                }
            } catch (error) {
                state.practicalOutput = `${currentLang === 'ru' ? '–û—à–∏–±–∫–∞: ' : '“ö–∞—Ç–µ: '}${error.message}`;
            }
            
            render();
        }

        // ==================== –†–ï–ù–î–ï–†–ò–ù–ì ====================
        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            
            try {
                switch(state.step) {
                    case 'upload':
                        app.innerHTML = renderUpload();
                        break;
                    case 'main':
                        app.innerHTML = renderMainPage();
                        break;
                    case 'generating':
                        app.innerHTML = renderGenerating();
                        break;
                    case 'learning':
                        app.innerHTML = renderLearning();
                        break;
                    default:
                        app.innerHTML = renderUpload();
                }
            } catch (error) {
                console.error('Render error:', error);
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center p-8">
                        <div class="glass-card p-8 text-center">
                            <h1 class="text-2xl text-red-600 mb-4">${currentLang === 'ru' ? '–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è' : '–ö”©—Ä—Å–µ—Ç—É “õ–∞—Ç–µ—Å—ñ'}</h1>
                            <p class="text-gray-600 mb-4">${error.message}</p>
                            <button class="btn-primary" onclick="backToHome()">${t('back')}</button>
                        </div>
                    </div>
                `;
            }
        }

        function renderUpload() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="max-w-2xl w-full fade-in">
                        <div class="glass-card p-8">
                            <div class="text-center mb-8">
                                <h1 class="text-4xl font-bold mb-2" style="color: #3559D5;">${t('createCourse')}</h1>
                                <p class="text-gray-600">${t('uploadDescription')}</p>
                            </div>

                            <div class="mb-6">
                                <div class="upload-zone" onclick="document.getElementById('pdf-input').click()">
                                    <div class="icon-large">
                                        <i class="fas fa-file-pdf"></i>
                                    </div>
                                    <h3 class="text-xl font-semibold mb-2 text-gray-800">${t('uploadPdf')}</h3>
                                    <p class="text-gray-500 mb-4">${t('clickOrDrag')}</p>
                                    <p id="file-name" class="text-sm text-gray-400">${t('fileNotSelected')}</p>
                                    <input type="file" id="pdf-input" accept=".pdf" 
                                           onchange="handleFileSelect(event)" class="hidden">
                                </div>
                            </div>

                            <button id="generate-btn" onclick="generateMicrolearning()" 
                                    disabled class="btn-primary w-full text-lg py-4">
                                <i class="fas fa-robot mr-2"></i>${t('createMicrolearning')}
                            </button>

                            <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É -->
                            <div class="text-center mt-6">
                                <button onclick="showMainPage()" class="btn-secondary">
                                    <i class="fas fa-book mr-2"></i>${t('toMainPage')}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainPage() {
            return `
                <div class="min-h-screen p-6">
                    <div class="max-w-6xl mx-auto">
                        <div class="glass-card p-8 mb-8">
                            <div class="flex justify-between items-center">
                                <h1 class="text-3xl font-bold text-gray-800">${t('myCourses')}</h1>
                                <button onclick="backToHome()" class="btn-primary">
                                    <i class="fas fa-plus mr-2"></i>${t('createNewCourse')}
                                </button>
                            </div>
                        </div>

                        ${state.courses.length === 0 ? `
                            <div class="glass-card p-12 text-center">
                                <div class="icon-large text-gray-400 mb-4">
                                    <i class="fas fa-book-open"></i>
                                </div>
                                <h2 class="text-2xl font-bold mb-4 text-gray-600">${t('noCourses')}</h2>
                                <p class="text-gray-500 mb-6">${t('uploadDescription')}</p>
                                <button onclick="backToHome()" class="btn-primary">
                                    <i class="fas fa-plus mr-2"></i>${t('createNewCourse')}
                                </button>
                            </div>
                        ` : `
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${state.courses.map(course => `
                                    <div class="glass-card p-6 fade-in">
                                        <div class="flex justify-between items-start mb-4">
                                            <h3 class="text-xl font-bold text-gray-800 truncate">${course.title}</h3>
                                            <button onclick="deleteCourse(${course.id})" class="text-red-500 hover:text-red-700">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <p class="text-gray-600 text-sm mb-4">
                                            ${t('created')}: ${new Date(course.createdAt).toLocaleDateString()}
                                        </p>
                                        <div class="flex justify-between items-center">
                                            <button onclick="loadCourse(${course.id})" class="btn-primary">
                                                ${t('continueLearning')}
                                            </button>
                                            <div class="text-sm text-gray-500">
                                                ${Object.values(course.completedModules).filter(v => v).length}/4 ${t('modules')}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderGenerating() {
            return `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="glass-card p-12 text-center max-w-md fade-in">
                        <div class="spinner mx-auto mb-6"></div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-800">${t('generatingCourse')}</h2>
                        <p class="text-gray-600">${t('analyzingMaterial')}</p>
                        <p class="text-sm text-gray-500 mt-4">${t('mayTakeTime')}</p>
                    </div>
                </div>
            `;
        }

        function renderLearning() {
            const course = state.currentCourse;
            const completed = Object.values(state.completedModules).filter(v => v).length;
            const progress = (completed / 4) * 100;

            return `
                <div class="min-h-screen bg-gray-50">
                    <div class="max-w-7xl mx-auto p-6">
                        <!-- Header -->
                        <div class="glass-card p-6 mb-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <button onclick="showMainPage()" class="btn-secondary mr-4">
                                        <i class="fas fa-arrow-left mr-2"></i>${t('back')}
                                    </button>
                                    <div>
                                        <h1 class="text-2xl font-bold text-gray-800">${course.title}</h1>
                                        <p class="text-gray-600">${t('progress')}: ${completed}/4 ${t('modules')}</p>
                                    </div>
                                </div>
                                <div class="w-48">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${progress}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                            <!-- Sidebar -->
                            <div class="lg:col-span-1">
                                <div class="glass-card p-6">
                                    <h3 class="text-lg font-semibold mb-4 text-gray-800">${t('courseModules')}</h3>
                                    <div class="space-y-3">
                                        ${renderSidebarItem('theory', 'book', t('theory'), `${course.microlearning.theory.length} ${t('pages')}`)}
                                        ${renderSidebarItem('flashcards', 'layer-group', t('flashcards'), `${course.microlearning.flashcards.length} ${t('cards')}`)}
                                        ${renderSidebarItem('textQuiz', 'question-circle', t('tests'), `${course.microlearning.textQuiz.length} ${t('tasks')}`)}
                                        ${renderSidebarItem('practicalQuiz', 'code', t('practice'), `${course.microlearning.practicalQuiz.length} ${t('tasks')}`)}
                                    </div>
                                </div>
                            </div>

                            <!-- Content -->
                            <div class="lg:col-span-3">
                                <div class="glass-card p-8">
                                    ${renderModuleContent()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSidebarItem(id, icon, title, subtitle) {
            const isActive = state.currentModule === id;
            const isCompleted = state.completedModules[id];
            const classes = `sidebar-item ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}`;
            
            return `
                <div onclick="openModule('${id}')" class="${classes}">
                    <div class="flex items-center gap-3">
                        <span class="text-xl w-6 text-center">
                            <i class="fas fa-${icon}"></i>
                        </span>
                        <div class="flex-1">
                            <div class="font-medium">${title}</div>
                            <div class="text-xs opacity-70">${subtitle}</div>
                        </div>
                        ${isCompleted ? '<i class="fas fa-check text-green-500"></i>' : ''}
                    </div>
                </div>
            `;
        }

        function renderModuleContent() {
            if (!state.currentCourse || !state.currentModule) {
                return '<p class="text-center text-gray-600">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥—É–ª—å –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—É—á–µ–Ω–∏—è</p>';
            }

            const module = state.currentCourse.microlearning[state.currentModule];
            if (!module || module.length === 0) {
                return '<p class="text-center text-gray-600">–ú–æ–¥—É–ª—å –ø—É—Å—Ç</p>';
            }

            switch(state.currentModule) {
                case 'theory': 
                    return renderTheory();
                case 'flashcards': 
                    return renderFlashcards();
                case 'textQuiz': 
                    return state.quizResults ? renderQuizResults() : renderTextQuiz();
                case 'practicalQuiz': 
                    return renderPractical();
                default: 
                    return '<p class="text-center text-gray-600">–ú–æ–¥—É–ª—å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>';
            }
        }

        function renderTheory() {
            const pages = state.currentCourse.microlearning.theory;
            const page = pages[state.currentTheoryPage];
            const allPagesViewed = isAllPagesViewed('theory');
            
            markPageViewed('theory', state.currentTheoryPage);

            if (!page) {
                return '<p class="text-center text-gray-600">–°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>';
            }

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const processedContent = processTheoryContent(page.content);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            setTimeout(() => {
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }, 100);

            return `
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold mb-2 text-gray-800">${page.title}</h1>
                            <p class="text-gray-600">${t('page')} ${state.currentTheoryPage + 1} ${t('of')} ${pages.length}</p>
                        </div>
                        <button onclick="completeModule()" 
                                class="btn-primary ${!allPagesViewed ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${!allPagesViewed ? 'disabled' : ''}
                                title="${!allPagesViewed ? (currentLang === 'ru' ? '–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –º–æ–¥—É–ª—è' : '–ú–æ–¥—É–ª—å–¥—ñ –∞—è“õ—Ç–∞–º–∞—Å –±“±—Ä—ã–Ω –±–∞—Ä–ª—ã“õ –±–µ—Ç—Ç–µ—Ä–¥—ñ “õ–∞—Ä–∞“£—ã–∑') : ''}">
                            <i class="fas fa-check mr-2"></i>${t('completeModule')}
                        </button>
                    </div>

                    <div class="page-indicator">
                        ${pages.map((_, i) => 
                            `<div class="page-dot ${i === state.currentTheoryPage ? 'active' : ''}"></div>`
                        ).join('')}
                    </div>

                    <div class="theory-content mb-8">
                        ${processedContent}
                    </div>

                    <div class="nav-container">
                        <button onclick="prevTheoryPage()" 
                                class="btn-secondary ${state.currentTheoryPage === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${state.currentTheoryPage === 0 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left mr-2"></i>${t('previous')}
                        </button>
                        
                        <span class="text-gray-600">${state.currentTheoryPage + 1} / ${pages.length}</span>
                        
                        <button onclick="nextTheoryPage()" 
                                class="btn-secondary ${state.currentTheoryPage === pages.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${state.currentTheoryPage === pages.length - 1 ? 'disabled' : ''}>
                            ${t('next')}<i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderFlashcards() {
            const cards = state.currentCourse.microlearning.flashcards;
            const card = cards[state.currentCardIndex];
            const progress = ((state.currentCardIndex + 1) / cards.length) * 100;
            const allCardsViewed = isAllPagesViewed('flashcards');
            
            markPageViewed('flashcards', state.currentCardIndex);

            if (!card) {
                return '<p class="text-center text-gray-600">–ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</p>';
            }

            return `
                <div class="max-w-2xl mx-auto fade-in">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold mb-2 text-gray-800">${t('flashcards')}</h1>
                            <p class="text-gray-600">${t('cards')} ${state.currentCardIndex + 1} ${t('of')} ${cards.length}</p>
                        </div>
                        <button onclick="completeModule()" 
                                class="btn-primary ${!allCardsViewed ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${!allCardsViewed ? 'disabled' : ''}
                                title="${!allCardsViewed ? (currentLang === 'ru' ? '–ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –º–æ–¥—É–ª—è' : '–ú–æ–¥—É–ª—å–¥—ñ –∞—è“õ—Ç–∞–º–∞—Å –±“±—Ä—ã–Ω –±–∞—Ä–ª—ã“õ –∫–∞—Ä—Ç–∞–ª–∞—Ä–¥—ã “õ–∞—Ä–∞“£—ã–∑') : ''}">
                            <i class="fas fa-check mr-2"></i>${t('completeModule')}
                        </button>
                    </div>

                    <div class="progress-bar mb-8">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>

                    <div class="flashcard mb-8" onclick="flipCard()">
                        <div class="flashcard-inner">
                            <div class="flashcard-front">
                                <div class="text-center">
                                    <div class="text-4xl font-bold mb-6 text-blue-500">
                                        <i class="fas fa-layer-group"></i>
                                    </div>
                                    <h2 class="text-2xl font-semibold text-gray-800">${card.front}</h2>
                                    <p class="text-sm text-gray-500 mt-6">${t('flipCard')}</p>
                                </div>
                            </div>
                            <div class="flashcard-back">
                                <div class="text-center">
                                    <p class="text-xl font-semibold">${card.back}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="nav-container">
                        <button onclick="prevCard()" 
                                class="btn-secondary ${state.currentCardIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${state.currentCardIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left mr-2"></i>${t('previous')}
                        </button>
                        
                        <span class="text-gray-600">${state.currentCardIndex + 1} / ${cards.length}</span>
                        
                        <button onclick="nextCard()" 
                                class="btn-secondary ${state.currentCardIndex === cards.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${state.currentCardIndex === cards.length - 1 ? 'disabled' : ''}>
                            ${t('next')}<i class="fas fa-chevron-right ml-2"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderTextQuiz() {
            const questions = state.currentCourse.microlearning.textQuiz;
            const q = questions[state.currentQuestionIndex];
            const progress = ((state.currentQuestionIndex + 1) / questions.length) * 100;
            const isLast = state.currentQuestionIndex === questions.length - 1;
            const isLocked = state.lockedQuestions.has(state.currentQuestionIndex);

            if (!q) {
                return '<p class="text-center text-gray-600">–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω</p>';
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ options –¥–ª—è multiple_choice –≤–æ–ø—Ä–æ—Å–æ–≤
            if (q.type === 'multiple_choice' && (!q.options || !Array.isArray(q.options) || q.options.length === 0)) {
                console.error('‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –≤–æ–ø—Ä–æ—Å–∞:', state.currentQuestionIndex, q);
                
                q.options = [
                    currentLang === 'ru' ? "–î–∞, —ç—Ç–æ –≤–µ—Ä–Ω–æ" : "–ò—è, –±“±–ª –¥“±—Ä—ã—Å",
                    currentLang === 'ru' ? "–ù–µ—Ç, —ç—Ç–æ –Ω–µ–≤–µ—Ä–Ω–æ" : "–ñ–æ“õ, –±“±–ª –¥“±—Ä—ã—Å –µ–º–µ—Å", 
                    currentLang === 'ru' ? "–ß–∞—Å—Ç–∏—á–Ω–æ –≤–µ—Ä–Ω–æ" : "–Ü—à—ñ–Ω–∞—Ä–∞ –¥“±—Ä—ã—Å",
                    currentLang === 'ru' ? "–ó–∞—Ç—Ä—É–¥–Ω—è—é—Å—å –æ—Ç–≤–µ—Ç–∏—Ç—å" : "–ñ–∞—É–∞–ø –±–µ—Ä—É “õ–∏—ã–Ω"
                ];
                
                if (q.correctAnswer === undefined && q.correct_answer === undefined) {
                    q.correctAnswer = 0;
                }
            }

            // –î–ª—è true_false –≤–æ–ø—Ä–æ—Å–æ–≤ —Å–æ–∑–¥–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
            if (q.type === 'true_false' && (!q.options || !Array.isArray(q.options) || q.options.length === 0)) {
                q.options = [
                    currentLang === 'ru' ? "–í–µ—Ä–Ω–æ" : "–î“±—Ä—ã—Å", 
                    currentLang === 'ru' ? "–ù–µ–≤–µ—Ä–Ω–æ" : "“ö–∞—Ç–µ"
                ];
            }

            return `
                <div class="max-w-3xl mx-auto fade-in">
                    <div class="mb-8">
                        <h1 class="text-3xl font-bold mb-2 text-gray-800">${t('testTasks')}</h1>
                        <p class="text-gray-600">${t('question')} ${state.currentQuestionIndex + 1} ${t('of')} ${questions.length}</p>
                        ${questions.length >= 10 ? `<p class="text-sm text-green-600 mt-1"><i class="fas fa-check-circle mr-1"></i>${currentLang === 'ru' ? '–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤' : '–ñ–µ—Ç–∫—ñ–ª—ñ–∫—Ç—ñ —Å“±—Ä–∞“õ—Ç–∞—Ä —Å–∞–Ω—ã'}</p>` : ''}
                    </div>

                    <div class="progress-bar mb-8">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>

                    <div class="mb-8">
                        <h2 class="text-xl font-semibold mb-6 text-gray-800">${q.question || (currentLang === 'ru' ? '–í–æ–ø—Ä–æ—Å –Ω–µ —É–∫–∞–∑–∞–Ω' : '–°“±—Ä–∞“õ –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ–≥–µ–Ω')}</h2>

                        ${q.type === 'multiple_choice' ? `
                            <div class="space-y-4">
                                ${q.options.map((opt, i) => {
                                    const isSelected = state.quizAnswers[state.currentQuestionIndex] === i;
                                    const isLockedClass = isLocked ? 'locked' : '';
                                    const selectedClass = isSelected ? 'selected' : '';
                                    return `
                                        <div onclick="selectAnswer(${state.currentQuestionIndex}, ${i})" 
                                             class="quiz-option ${selectedClass} ${isLockedClass}">
                                                <div class="flex items-center gap-4">
                                                    <div class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-semibold ${
                                                        isSelected ? 
                                                        'border-blue-500 bg-blue-500 text-white' : 'border-gray-300 text-gray-600'
                                                    }">
                                                        ${String.fromCharCode(65 + i)}
                                                    </div>
                                                    <span class="text-gray-800">${opt}</span>
                                                </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : q.type === 'true_false' ? `
                            <div class="space-y-4">
                                <div onclick="selectAnswer(${state.currentQuestionIndex}, 0)" 
                                     class="quiz-option ${state.quizAnswers[state.currentQuestionIndex] === 0 ? 'selected' : ''} ${isLocked ? 'locked' : ''}">
                                    <div class="flex items-center gap-4">
                                        <i class="fas fa-check text-green-500 text-xl"></i>
                                        <span class="text-lg font-semibold text-gray-800">${currentLang === 'ru' ? '–í–µ—Ä–Ω–æ' : '–î“±—Ä—ã—Å'}</span>
                                    </div>
                                </div>
                                <div onclick="selectAnswer(${state.currentQuestionIndex}, 1)" 
                                     class="quiz-option ${state.quizAnswers[state.currentQuestionIndex] === 1 ? 'selected' : ''} ${isLocked ? 'locked' : ''}">
                                    <div class="flex items-center gap-4">
                                        <i class="fas fa-times text-red-500 text-xl"></i>
                                        <span class="text-lg font-semibold text-gray-800">${currentLang === 'ru' ? '–ù–µ–≤–µ—Ä–Ω–æ' : '“ö–∞—Ç–µ'}</span>
                                    </div>
                                </div>
                            </div>
                        ` : q.type === 'short_answer' ? `
                            <div class="space-y-4">
                                <textarea 
                                    oninput="updateShortAnswer(${state.currentQuestionIndex}, this.value)"
                                    placeholder="${currentLang === 'ru' ? '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å...' : '–ñ–∞—É–∞–±—ã“£—ã–∑–¥—ã –æ—Å—ã –∂–µ—Ä–≥–µ –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑...'}"
                                    class="w-full border border-gray-300 rounded-xl p-4 resize-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors"
                                    rows="4"
                                    ${isLocked ? 'disabled' : ''}
                                >${state.quizAnswers[state.currentQuestionIndex] || ''}</textarea>
                                
                                ${!isLocked && !state.aiCheckResults[state.currentQuestionIndex] ? `
                                    <button onclick="checkShortAnswer()" 
                                            class="btn-primary ${state.checkingShortAnswer || !canProceedToNext() ? 'opacity-50 cursor-not-allowed' : ''}"
                                            ${state.checkingShortAnswer || !canProceedToNext() ? 'disabled' : ''}>
                                        ${state.checkingShortAnswer ? 
                                            `<i class="fas fa-spinner fa-spin mr-2"></i>${currentLang === 'ru' ? '–ü—Ä–æ–≤–µ—Ä—è—é...' : '–¢–µ–∫—Å–µ—Ä—ñ–ª—É–¥–µ...'}` :
                                            `<i class="fas fa-check-circle mr-2"></i>${currentLang === 'ru' ? '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç' : '–ñ–∞—É–∞–ø—Ç—ã —Ç–µ–∫—Å–µ—Ä—É'}`
                                        }
                                    </button>
                                ` : ''}
                                
                                ${state.aiCheckResults[state.currentQuestionIndex] ? `
                                    <div class="border rounded-xl p-4 ${state.aiCheckResults[state.currentQuestionIndex].isCorrect ? 'border-green-200 bg-green-50' : 'border-orange-200 bg-orange-50'}">
                                        <div class="flex items-start gap-3 mb-3">
                                            <div class="text-2xl ${state.aiCheckResults[state.currentQuestionIndex].isCorrect ? 'text-green-500' : 'text-orange-500'}">
                                                <i class="fas fa-${state.aiCheckResults[state.currentQuestionIndex].isCorrect ? 'check-circle' : 'info-circle'}"></i>
                                            </div>
                                            <div class="flex-1">
                                                <h3 class="font-semibold mb-2 ${state.aiCheckResults[state.currentQuestionIndex].isCorrect ? 'text-green-700' : 'text-orange-700'}">
                                                    ${currentLang === 'ru' ? '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏' : '–¢–µ–∫—Å–µ—Ä—É –Ω”ô—Ç–∏–∂–µ—Å—ñ'} 
                                                    ${state.aiCheckResults[state.currentQuestionIndex].score ? `(${state.aiCheckResults[state.currentQuestionIndex].score}/10)` : ''}
                                                </h3>
                                                <p class="text-gray-700 whitespace-pre-wrap">${state.aiCheckResults[state.currentQuestionIndex].feedback}</p>
                                            </div>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                ${state.checkingShortAnswer ? `
                                    <div class="flex items-center justify-center gap-3 p-4 bg-blue-50 rounded-xl">
                                        <div class="small-spinner"></div>
                                        <p class="text-blue-700">${currentLang === 'ru' ? '–ò–ò –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à –æ—Ç–≤–µ—Ç...' : 'AI –∂–∞—É–∞–±—ã“£—ã–∑–¥—ã —Ç–µ–∫—Å–µ—Ä—É–¥–µ...'}</p>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mb-2"></i>
                                <p class="text-yellow-700">${currentLang === 'ru' ? '–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞ "' : '–°“±—Ä–∞“õ —Ç“Ø—Ä—ñ "'}${q.type}" ${currentLang === 'ru' ? '–ø–æ–∫–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è' : '”ô–ª—ñ “õ–æ–ª–¥–∞—É –∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ–π–¥—ñ'}</p>
                            </div>
                        `}
                    </div>

                    <div class="nav-container">
                        <button onclick="prevQuestion()" 
                                class="btn-secondary ${state.currentQuestionIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${state.currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left mr-2"></i>${t('previous')}
                        </button>
                        
                        <span class="text-gray-600">${state.currentQuestionIndex + 1} / ${questions.length}</span>
                        
                        <button onclick="${isLast ? 'submitTextQuiz()' : 'nextQuestion()'}" 
                                class="${isLast ? 'btn-primary' : 'btn-secondary'} ${!canProceedToNext() ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${!canProceedToNext() ? 'disabled' : ''}>
                            ${isLast ? `<i class="fas fa-check mr-2"></i>${t('submitTest')}` : `${t('next')}<i class="fas fa-chevron-right ml-2"></i>`}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderQuizResults() {
            const results = state.quizResults;
            const correct = results.filter(r => r.isCorrect).length;
            const percentage = Math.round((correct / results.length) * 100);

            return `
                <div class="max-w-3xl mx-auto fade-in">
                    <div class="text-center mb-8">
                        <div class="icon-large ${percentage >= 70 ? 'text-green-500' : 'text-orange-500'}">
                            <i class="fas fa-${percentage >= 70 ? 'trophy' : 'redo'}"></i>
                        </div>
                        <h2 class="text-3xl font-bold mb-2 text-gray-800">${t('testResults')}</h2>
                        <p class="text-2xl mb-4 ${percentage >= 70 ? 'text-green-600' : 'text-orange-600'}">
                            ${correct} ${t('of')} ${results.length} (${percentage}%)
                        </p>
                        <p class="text-gray-600">${percentage >= 70 ? t('excellent') : t('tryAgain')}</p>
                    </div>

                    <div class="space-y-4 mb-8">
                        ${results.map((r, i) => `
                            <div class="border rounded-xl p-6 ${r.isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                                <div class="flex items-start gap-4">
                                    <div class="text-2xl mt-1 ${r.isCorrect ? 'text-green-500' : 'text-red-500'}">
                                        <i class="fas fa-${r.isCorrect ? 'check' : 'times'}"></i>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="font-semibold mb-2 text-gray-800">${i + 1}. ${r.question}</h3>
                                        ${r.type === 'multiple_choice' ? `
                                            <p class="text-gray-600 mb-2">
                                                ${t('yourAnswer')}: <span class="${r.isCorrect ? 'text-green-600' : 'text-red-600'} font-medium">${r.options[r.userAnswer]}</span>
                                                ${!r.isCorrect ? `<br>${t('correctAnswer')}: <span class="text-green-600 font-medium">${r.options[r.correctAnswer]}</span>` : ''}
                                            </p>
                                        ` : r.type === 'true_false' ? `
                                            <p class="text-gray-600 mb-2">
                                                ${t('yourAnswer')}: <span class="${r.isCorrect ? 'text-green-600' : 'text-red-600'} font-medium">${r.userAnswer === 0 ? (currentLang === 'ru' ? '–í–µ—Ä–Ω–æ' : '–î“±—Ä—ã—Å') : (currentLang === 'ru' ? '–ù–µ–≤–µ—Ä–Ω–æ' : '“ö–∞—Ç–µ')}</span>
                                                ${!r.isCorrect ? `<br>${t('correctAnswer')}: <span class="text-green-600 font-medium">${r.correctAnswer ? (currentLang === 'ru' ? '–í–µ—Ä–Ω–æ' : '–î“±—Ä—ã—Å') : (currentLang === 'ru' ? '–ù–µ–≤–µ—Ä–Ω–æ' : '“ö–∞—Ç–µ')}</span>` : ''}
                                            </p>
                                        ` : ''}
                                        <p class="text-sm text-gray-600 bg-white p-3 rounded-lg">${r.explanation}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="text-center">
                        <button onclick="openModule('textQuiz')" class="btn-secondary mr-4">
                            <i class="fas fa-redo mr-2"></i>${t('retakeTest')}
                        </button>
                        <button onclick="completeModule()" class="btn-primary">
                            <i class="fas fa-check mr-2"></i>${t('completeModule')}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPractical() {
            const tasks = state.currentCourse.microlearning.practicalQuiz;
            const task = tasks[state.currentQuestionIndex];
            const isLast = state.currentQuestionIndex === tasks.length - 1;

            if (!task) {
                return '<p class="text-center text-gray-600">–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
            }

            if (task.type === 'code') {
                const code = state.practicalCode || task.initialCode;
                const canRunHTML = task.language === 'html' || task.language === 'css' || task.language === 'javascript';
                const allTasksCompleted = isAllTasksCompleted('practicalQuiz');
                
                return `
                    <div class="max-w-4xl mx-auto fade-in">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold mb-2 text-gray-800">${t('practicalTask')}</h1>
                            <p class="text-gray-600">${t('task')} ${state.currentQuestionIndex + 1} ${t('of')} ${tasks.length}</p>
                        </div>

                        <div class="mb-6">
                            <h2 class="text-xl font-semibold mb-4 text-gray-800">${task.task}</h2>
                            
                            <div class="mb-6">
                                <label class="block text-sm font-medium mb-3 text-gray-700">${t('codeEditor')} (${task.language || 'python'}):</label>
                                <textarea class="code-editor" rows="12" 
                                          oninput="updatePracticalCode(this.value)">${code}</textarea>
                            </div>

                            <div class="flex gap-3 mb-6">
                                ${canRunHTML ? `
                                    <button onclick="runCode()" class="btn-secondary">
                                        <i class="fas fa-play mr-2"></i>${t('runCode')}
                                    </button>
                                ` : ''}
                                <button onclick="checkPracticalAnswer()" class="btn-primary ${state.checkingAnswer ? 'opacity-70 cursor-wait' : ''}" ${state.checkingAnswer ? 'disabled' : ''}>
                                    <i class="fas fa-check mr-2"></i>${state.checkingAnswer ? t('checking') : t('checkCode')}
                                </button>
                            </div>

                            ${state.checkingAnswer ? `
                                <div class="loading-indicator mb-6">
                                    <div class="small-spinner"></div>
                                    <p class="text-gray-600">${t('aiChecking')}</p>
                                </div>
                            ` : ''}

                            ${state.practicalCheckResult ? `
                                <div class="mb-6 p-6 rounded-xl ${state.practicalCheckResult.isCorrect ? 'bg-green-50 border-2 border-green-500' : 'bg-red-50 border-2 border-red-500'}">
                                    <div class="flex items-start gap-3 mb-4">
                                        <div class="text-3xl ${state.practicalCheckResult.isCorrect ? 'text-green-500' : 'text-red-500'}">
                                            <i class="fas fa-${state.practicalCheckResult.isCorrect ? 'check-circle' : 'times-circle'}"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold mb-3 ${state.practicalCheckResult.isCorrect ? 'text-green-800' : 'text-red-800'}">
                                                ${state.practicalCheckResult.isCorrect ? t('greatCodeCorrect') : t('needsImprovement')}
                                            </h3>
                                            <p class="text-base ${state.practicalCheckResult.isCorrect ? 'text-green-700' : 'text-red-700'} mb-3">${state.practicalCheckResult.feedback}</p>
                                            
                                            ${state.practicalCheckResult.errors && state.practicalCheckResult.errors.length > 0 ? `
                                                <div class="mt-4 p-4 bg-white rounded-lg border border-red-300">
                                                    <p class="font-semibold text-red-800 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>${t('errorsFound')}:</p>
                                                    <ul class="list-disc list-inside text-red-700 space-y-1">
                                                        ${state.practicalCheckResult.errors.map(err => `<li>${err}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            
                                            ${state.practicalCheckResult.suggestions && state.practicalCheckResult.suggestions.length > 0 ? `
                                                <div class="mt-4 p-4 bg-white rounded-lg border ${state.practicalCheckResult.isCorrect ? 'border-green-300' : 'border-yellow-300'}">
                                                    <p class="font-semibold ${state.practicalCheckResult.isCorrect ? 'text-green-800' : 'text-yellow-800'} mb-2"><i class="fas fa-lightbulb mr-2"></i>${t('suggestions')}:</p>
                                                    <ul class="list-disc list-inside ${state.practicalCheckResult.isCorrect ? 'text-green-700' : 'text-yellow-700'} space-y-1">
                                                        ${state.practicalCheckResult.suggestions.map(sug => `<li>${sug}</li>`).join('')}
                                                    </ul>
                                                </div>
                                            ` : ''}
                                            
                                            ${state.practicalCheckResult.result_preview ? `
                                                <div class="mt-4 p-4 bg-white rounded-lg border border-green-300">
                                                    <p class="font-semibold text-green-800 mb-2"><i class="fas fa-eye mr-2"></i>${t('expectedResult')}:</p>
                                                    <pre class="text-green-700 font-mono text-sm whitespace-pre-wrap">${state.practicalCheckResult.result_preview}</pre>
                                                </div>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${state.practicalOutput && !code.includes('<html') && !code.includes('<!DOCTYPE') ? `
                                <div class="mb-6">
                                    <label class="block text-sm font-medium mb-3 text-gray-700">${currentLang === 'ru' ? '–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:' : '–û—Ä—ã–Ω–¥–∞—É –Ω”ô—Ç–∏–∂–µ—Å—ñ:'}</label>
                                    <div class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm whitespace-pre-wrap">${state.practicalOutput}</div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="nav-container">
                            <button onclick="prevPractical()" 
                                    class="btn-secondary ${state.currentQuestionIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${state.currentQuestionIndex === 0 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left mr-2"></i>${t('previous')}
                            </button>
                            
                            <span class="text-gray-600">${state.currentQuestionIndex + 1} / ${tasks.length}</span>
                            
                            ${!isLast ? `
                                <button onclick="nextPractical()" class="btn-secondary">
                                    ${t('next')}<i class="fas fa-chevron-right ml-2"></i>
                                </button>
                            ` : `
                                <button onclick="completeModule()" 
                                        class="btn-primary ${!allTasksCompleted ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${!allTasksCompleted ? 'disabled' : ''}
                                        title="${!allTasksCompleted ? (currentLang === 'ru' ? '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –º–æ–¥—É–ª—è' : '–ú–æ–¥—É–ª—å–¥—ñ –∞—è“õ—Ç–∞–º–∞—Å –±“±—Ä—ã–Ω –±–∞—Ä–ª—ã“õ —Ç–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä–¥—ã –æ—Ä—ã–Ω–¥–∞“£—ã–∑') : ''}">
                                    <i class="fas fa-check mr-2"></i>${t('completeModule')}
                                </button>
                            `}
                        </div>
                    </div>
                `;
            } else {
                const canProceed = state.practicalCheckResult?.isCorrect === true;
                const allTasksCompleted = isAllTasksCompleted('practicalQuiz');
                
                return `
                    <div class="max-w-3xl mx-auto fade-in">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold mb-2 text-gray-800">${t('practicalTask')}</h1>
                            <p class="text-gray-600">${t('task')} ${state.currentQuestionIndex + 1} ${t('of')} ${tasks.length}</p>
                        </div>

                        <div class="mb-6">
                            <h2 class="text-xl font-semibold mb-4 text-gray-800">${task.task}</h2>
                            
                            ${task.instructions ? `
                                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                                    <p class="text-sm font-medium mb-2 text-blue-800"><i class="fas fa-info-circle mr-2"></i>${t('instruction')}:</p>
                                    <p class="text-blue-700">${task.instructions}</p>
                                </div>
                            ` : ''}
                            
                            <textarea rows="10" placeholder="${t('writeSolution')}"
                                      oninput="updatePracticalCode(this.value)"
                                      class="w-full border border-gray-300 rounded-xl p-4 mb-4 resize-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-colors ${state.practicalCheckResult?.isCorrect ? 'border-green-500 bg-green-50' : ''}"
                                      ${canProceed ? 'disabled' : ''}
                                      >${state.practicalCode || ''}</textarea>

                            ${state.checkingAnswer ? `
                                <div class="loading-indicator mb-6">
                                    <div class="small-spinner"></div>
                                    <p class="text-gray-600">${currentLang === 'ru' ? 'AI –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à –æ—Ç–≤–µ—Ç...' : 'AI –∂–∞—É–∞–±—ã“£—ã–∑–¥—ã —Ç–µ–∫—Å–µ—Ä–µ–¥—ñ...'}</p>
                                </div>
                            ` : ''}

                            ${state.practicalCheckResult ? `
                                <div class="mb-6 p-4 rounded-xl ${state.practicalCheckResult.isCorrect ? 'bg-green-50 border-2 border-green-500' : 'bg-red-50 border-2 border-red-500'}">
                                    <div class="flex items-start gap-3">
                                        <div class="text-2xl ${state.practicalCheckResult.isCorrect ? 'text-green-500' : 'text-red-500'}">
                                            <i class="fas fa-${state.practicalCheckResult.isCorrect ? 'check-circle' : 'times-circle'}"></i>
                                        </div>
                                        <div class="flex-1">
                                            <h3 class="font-semibold mb-2 ${state.practicalCheckResult.isCorrect ? 'text-green-800' : 'text-red-800'}">
                                                ${state.practicalCheckResult.isCorrect ? `‚úì ${t('correct')}!` : `‚úó ${t('incorrect')}`}
                                            </h3>
                                            <p class="${state.practicalCheckResult.isCorrect ? 'text-green-700' : 'text-red-700'}">${state.practicalCheckResult.feedback}</p>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            ${!canProceed && !state.checkingAnswer ? `
                                <button onclick="checkPracticalAnswer()" class="btn-primary w-full mb-6">
                                    <i class="fas fa-check mr-2"></i>${t('checkAnswer')}
                                </button>
                            ` : ''}
                        </div>

                        <div class="nav-container">
                            <button onclick="prevPractical()" 
                                    class="btn-secondary ${state.currentQuestionIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${state.currentQuestionIndex === 0 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left mr-2"></i>${t('previous')}
                            </button>
                            
                            <span class="text-gray-600">${state.currentQuestionIndex + 1} / ${tasks.length}</span>
                            
                            ${!isLast ? `
                                <button onclick="nextPractical()" 
                                        class="btn-secondary ${!canProceed ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${!canProceed ? 'disabled' : ''}>
                                    ${t('next')}<i class="fas fa-chevron-right ml-2"></i>
                                </button>
                            ` : `
                                <button onclick="completeModule()" 
                                        class="btn-primary ${!allTasksCompleted ? 'opacity-50 cursor-not-allowed' : ''}"
                                        ${!allTasksCompleted ? 'disabled' : ''}
                                        title="${!allTasksCompleted ? (currentLang === 'ru' ? '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –º–æ–¥—É–ª—è' : '–ú–æ–¥—É–ª—å–¥—ñ –∞—è“õ—Ç–∞–º–∞—Å –±“±—Ä—ã–Ω –±–∞—Ä–ª—ã“õ —Ç–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä–¥—ã –æ—Ä—ã–Ω–¥–∞“£—ã–∑') : ''}">
                                    <i class="fas fa-check mr-2"></i>${t('completeModule')}
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }
        }

        // ==================== –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ====================
        
        // ==================== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –¢–ï–ú–´ ====================
        
        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.getElementById('theme-toggle');
            const icon = themeToggle.querySelector('i');
            
            body.classList.toggle('dark-theme');
            
            // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É
            if (body.classList.contains('dark-theme')) {
                icon.className = 'fas fa-sun';
                themeToggle.title = currentLang === 'ru' ? '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : '–ê—à—ã“õ —Ç–∞“õ—ã—Ä—ã–ø';
                localStorage.setItem('ai-ustaz_theme', 'dark');
            } else {
                icon.className = 'fas fa-moon';
                themeToggle.title = currentLang === 'ru' ? '–¢–µ–º–Ω–∞—è —Ç–µ–º–∞' : '“ö–∞—Ä–∞“£“ì—ã —Ç–∞“õ—ã—Ä—ã–ø';
                localStorage.setItem('ai-ustaz_theme', 'light');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —Ç–µ–º—ã
        function loadTheme() {
            const savedTheme = localStorage.getItem('ai-ustaz_theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-theme');
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    const icon = themeToggle.querySelector('i');
                    icon.className = 'fas fa-sun';
                    themeToggle.title = currentLang === 'ru' ? '–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : '–ê—à—ã“õ —Ç–∞“õ—ã—Ä—ã–ø';
                }
            }
        }
        
        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('ai-ustaz_lang', lang);
            
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`lang-${lang}`).classList.add('active');
            
            document.documentElement.lang = lang;
            
            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∫–Ω–æ–ø–∫–∏ "–ù–∞ –≥–ª–∞–≤–Ω—É—é"
            const homeBtn = document.querySelector('.home-btn-text');
            if (homeBtn) {
                homeBtn.textContent = homeBtn.getAttribute(`data-${lang}`);
            }
            
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –Ω–æ–≤—ã–º —è–∑—ã–∫–æ–º
            render();
        }
        
        
        // ==================== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–õ–£–ß–®–ï–ù–ù–û–ì–û –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –¢–ï–û–†–ò–ò ====================
        
        
        function processTheoryContent(content) {
            if (!content) return '';
            
            // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
            const codeBlocks = [];
            let processedText = content.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                const placeholder = `___CODE_BLOCK_${codeBlocks.length}___`;
                codeBlocks.push({ lang: lang || 'text', code: code.trim() });
                return placeholder;
            });
            
            let paragraphs = processedText.split('\n').filter(p => p.trim());
            let processedContent = '';
            let inList = false;
            let inSection = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ–π —Å–µ–∫—Ü–∏–∏
            
            paragraphs.forEach((para, index) => {
                para = para.trim();
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –∫–æ–¥–∞
                const codeMatch = para.match(/___CODE_BLOCK_(\d+)___/);
                if (codeMatch) {
                    if (inList) {
                        processedContent += '</ul>';
                        inList = false;
                    }
                    const blockIndex = parseInt(codeMatch[1]);
                    const block = codeBlocks[blockIndex];
                    processedContent += createCodeBlock(block.code, block.lang);
                    return;
                }
                
                // –ó–∞–≥–æ–ª–æ–≤–∫–∏ ## - –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–µ–∫—Ü–∏—é –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–æ–≤—É—é
                if (para.match(/^##\s+/)) {
                    if (inList) {
                        processedContent += '</ul>';
                        inList = false;
                    }
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–µ–∫—Ü–∏—é
                    if (inSection) {
                        processedContent += '</div></div>'; // –ó–∞–∫—Ä—ã–≤–∞–µ–º theory-content –∏ theory-section
                    }
                    
                    let text = para.replace(/^##\s+/, '');
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —ç–º–æ–¥–∑–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                    const emojiMatch = text.match(/^([^\w\s–ê-–Ø–∞-—è–Å—ë”ò”ô“í“ì“ö“õ“¢“£”®”©“∞“±“Æ“Ø–Ü—ñ“∫“ª]+)\s+(.+)$/);
                    if (emojiMatch) {
                        const emoji = emojiMatch[1];
                        const title = emojiMatch[2];
                        processedContent += `
                            <div class="theory-section">
                                <div class="theory-header">
                                    <span class="emoji-header">${emoji}</span>
                                    <h2 class="theory-title">${title}</h2>
                                </div>
                                <div class="theory-content">
                        `;
                    } else {
                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é
                        const icon = getIconForSection(text);
                        processedContent += `
                            <div class="theory-section">
                                <div class="theory-header">
                                    <span class="theory-icon"><i class="fas fa-${icon}"></i></span>
                                    <h2 class="theory-title">${text}</h2>
                                </div>
                                <div class="theory-content">
                        `;
                    }
                    inSection = true;
                }
                else if (para.match(/^###\s+/)) {
                    if (inList) {
                        processedContent += '</ul>';
                        inList = false;
                    }
                    let text = para.replace(/^###\s+/, '');
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º —ç–º–æ–¥–∑–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                    const emojiMatch = text.match(/^([^\w\s–ê-–Ø–∞-—è–Å—ë”ò”ô“í“ì“ö“õ“¢“£”®”©“∞“±“Æ“Ø–Ü—ñ“∫“ª]+)\s+(.+)$/);
                    if (emojiMatch) {
                        const emoji = emojiMatch[1];
                        const title = emojiMatch[2];
                        processedContent += `<h3 style="font-size: 20px; font-weight: 700; color: #2d3748; margin: 20px 0 12px 0; display: flex; align-items: center;"><span style="margin-right: 8px;">${emoji}</span>${title}</h3>`;
                    } else {
                        processedContent += `<h3 style="font-size: 20px; font-weight: 700; color: #2d3748; margin: 20px 0 12px 0;">${text}</h3>`;
                    }
                }
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –±–ª–æ–∫–∏
                else if (para.toLowerCase().includes('“õ–∞—Ä–∞–ø–∞–π—ã–º —Ç—ñ–ª–º–µ–Ω:') || 
                         para.toLowerCase().includes('–ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏:') ||
                         para.toLowerCase().includes('—á—Ç–æ —ç—Ç–æ')) {
                    if (inList) {
                        processedContent += '</ul>';
                        inList = false;
                    }
                    const parts = para.split(/[::]/);
                    const title = parts[0];
                    const text = parts.slice(1).join(':').trim();
                    processedContent += `
                        <div class="info-box">
                            <span class="info-box-icon">üí°</span>
                            <div>
                                <strong style="color: #1e40af;">${title}:</strong> ${text}
                            </div>
                        </div>
                    `;
                }
                // –í–∞–∂–Ω–æ / –ú–∞“£—ã–∑–¥—ã
                else if (para.toLowerCase().startsWith('–≤–∞–∂–Ω–æ:') || 
                         para.toLowerCase().startsWith('–º–∞“£—ã–∑–¥—ã:') ||
                         para.toLowerCase().startsWith('–≤–Ω–∏–º–∞–Ω–∏–µ:')) {
                    if (inList) {
                        processedContent += '</ul>';
                        inList = false;
                    }
                    const text = para.replace(/^(–≤–∞–∂–Ω–æ:|–º–∞“£—ã–∑–¥—ã:|–≤–Ω–∏–º–∞–Ω–∏–µ:)/i, '').trim();
                    const contentLang = detectContentLanguage(content);
                    const labelText = contentLang === 'kk' ? '–ú–∞“£—ã–∑–¥—ã' : '–í–∞–∂–Ω–æ';
                    processedContent += `
                        <div class="warning-box">
                            <span class="warning-box-icon">‚ö†Ô∏è</span>
                            <div>
                                <strong style="color: #92400e;">${labelText}:</strong> ${text}
                            </div>
                        </div>
                    `;
                }
                // –°–æ–≤–µ—Ç / –ö–µ“£–µ—Å
                else if (para.toLowerCase().startsWith('—Å–æ–≤–µ—Ç:') || 
                         para.toLowerCase().startsWith('–∫–µ“£–µ—Å:') ||
                         para.toLowerCase().startsWith('–ø–æ–¥—Å–∫–∞–∑–∫–∞:')) {
                    if (inList) {
                        processedContent += '</ul>';
                        inList = false;
                    }
                    const text = para.replace(/^(—Å–æ–≤–µ—Ç:|–∫–µ“£–µ—Å:|–ø–æ–¥—Å–∫–∞–∑–∫–∞:)/i, '').trim();
                    const contentLang = detectContentLanguage(content);
                    const labelText = contentLang === 'kk' ? '–ö–µ“£–µ—Å' : '–°–æ–≤–µ—Ç';
                    processedContent += `
                        <div class="success-box">
                            <span class="success-box-icon">üí°</span>
                            <div>
                                <strong style="color: #065f46;">${labelText}:</strong> ${text}
                            </div>
                        </div>
                    `;
                }
                // –ü—Ä–∏–º–µ—Ä
                else if (para.toLowerCase().startsWith('–ø—Ä–∏–º–µ—Ä:') || 
                         para.toLowerCase().startsWith('–º—ã—Å–∞–ª:') ||
                         para.toLowerCase().startsWith('–Ω–∞–ø—Ä–∏–º–µ—Ä:')) {
                    if (inList) {
                        processedContent += '</ul>';
                        inList = false;
                    }
                    const text = para.replace(/^(–ø—Ä–∏–º–µ—Ä:|–º—ã—Å–∞–ª:|–Ω–∞–ø—Ä–∏–º–µ—Ä:)/i, '').trim();
                    const contentLang = detectContentLanguage(content);
                    const labelText = contentLang === 'kk' ? '–ú—ã—Å–∞–ª' : '–ü—Ä–∏–º–µ—Ä';
                    processedContent += `
                        <div class="example-box">
                            <div class="example-title">
                                <i class="fas fa-lightbulb"></i>${labelText}
                            </div>
                            <p>${text}</p>
                        </div>
                    `;
                }
                // –°–ø–∏—Å–∫–∏
                else if (para.match(/^[-‚Ä¢*]\s+/) || para.match(/^\d+\.\s+/)) {
                    if (!inList) {
                        processedContent += '<ul class="list-disc list-inside space-y-2 ml-4">';
                        inList = true;
                    }
                    const text = para.replace(/^[-‚Ä¢*\d+\.\s]+/, '');
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ strong —Ç–µ–≥–∞
                    const strongMatch = text.match(/^([^-]+)\s+-\s+(.+)$/);
                    if (strongMatch) {
                        processedContent += `<li><strong>${strongMatch[1]}</strong> - ${strongMatch[2]}</li>`;
                    } else {
                        processedContent += `<li>${text}</li>`;
                    }
                }
                // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
                else {
                    if (inList) {
                        processedContent += '</ul>';
                        inList = false;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ –∫–æ–¥ (HTML —Ç–µ–≥–∏, —Ñ—É–Ω–∫—Ü–∏–∏ –∏ —Ç.–¥.)
                    const codePatterns = [
                        /<!DOCTYPE/i,           // HTML doctype
                        /<html>/i,              // HTML —Ç–µ–≥
                        /<\/html>/i,            // –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π HTML
                        /<head>/i,              // Head —Ç–µ–≥
                        /<body>/i,              // Body —Ç–µ–≥
                        /<title>/i,             // Title —Ç–µ–≥
                        /<h\d>/i,               // –ó–∞–≥–æ–ª–æ–≤–∫–∏ h1-h6
                        /<p>/i,                 // –ü–∞—Ä–∞–≥—Ä–∞—Ñ
                        /<div/i,                // Div
                        /def\s+\w+\(/,          // Python —Ñ—É–Ω–∫—Ü–∏—è
                        /function\s+\w+\(/,     // JavaScript —Ñ—É–Ω–∫—Ü–∏—è
                        /console\.log\(/,       // Console.log
                        /print\(/,              // Print
                        /import\s+/,            // Import
                        /from\s+\w+\s+import/,  // Python from import
                        /public\s+class/,       // Java class
                        /#include\s*</,         // C++ include
                    ];
                    
                    const containsCode = codePatterns.some(pattern => pattern.test(para));
                    
                    if (containsCode) {
                        // –ü—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–∑—ã–∫
                        let detectedLang = 'text';
                        if (para.includes('<!DOCTYPE') || para.includes('<html>') || para.includes('<head>')) {
                            detectedLang = 'html';
                        } else if (para.includes('def ') || para.includes('print(')) {
                            detectedLang = 'python';
                        } else if (para.includes('function ') || para.includes('console.log')) {
                            detectedLang = 'javascript';
                        } else if (para.includes('public class') || para.includes('System.out')) {
                            detectedLang = 'java';
                        }
                        
                        // –°–æ–±–∏—Ä–∞–µ–º –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–π –∫–æ–¥
                        let codeLines = [para];
                        let j = index + 1;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç—Ä–æ–∫–∏ –Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–æ–¥–∞
                        while (j < paragraphs.length) {
                            const nextPara = paragraphs[j].trim();
                            // –ï—Å–ª–∏ —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ - –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∫–æ–¥–∞
                            const isCodeContinuation = 
                                nextPara.startsWith('<') || 
                                nextPara.startsWith('}') ||
                                nextPara.startsWith(')') ||
                                nextPara.includes('</') ||
                                (codeLines.length > 0 && nextPara.length > 0 && !nextPara.match(/^[–ê-–Ø–∞-—è–Å—ë”ò”ô“í“ì“ö“õ“¢“£”®”©“∞“±“Æ“Ø–Ü—ñ“∫“ª]/));
                            
                            if (isCodeContinuation && !nextPara.match(/^##/) && !nextPara.match(/^###/)) {
                                codeLines.push(nextPara);
                                // –ü–æ–º–µ—á–∞–µ–º —ç—Ç—É —Å—Ç—Ä–æ–∫—É –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—É—é
                                paragraphs[j] = '___PROCESSED___';
                                j++;
                            } else {
                                break;
                            }
                        }
                        
                        const fullCode = codeLines.join('\n');
                        processedContent += createCodeBlock(fullCode, detectedLang);
                    }
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
                    else if (para === '___PROCESSED___') {
                        // –ù–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                    }
                    // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
                    else {
                        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç–æ–π —Å–µ–∫—Ü–∏–∏ - —Å–æ–∑–¥–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—É—é
                        if (!inSection) {
                            processedContent += `
                                <div class="theory-section">
                                    <div class="theory-content">
                            `;
                            inSection = true;
                        }
                        
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–∏—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∫–∞–∫ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤
                        let processed = para.replace(/\*\*([^*]+)\*\*/g, '<span class="term-highlight">$1</span>');
                        processed = processed.replace(/\*([^*]+)\*/g, '<em>$1</em>');
                        processedContent += `<p style="margin: 12px 0; line-height: 1.8;">${processed}</p>`;
                    }
                }
            });
            
            if (inList) {
                processedContent += '</ul>';
            }
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –æ—Ç–∫—Ä—ã—Ç—É—é —Å–µ–∫—Ü–∏—é
            if (inSection) {
                processedContent += '</div></div>'; // –ó–∞–∫—Ä—ã–≤–∞–µ–º theory-content –∏ theory-section
            }
            
            return processedContent;
        }


        function detectContentLanguage(text) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–∞–∑–∞—Ö—Å–∫–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
    const kazakhChars = /[”ô“ì“õ“£”©“±“Ø—ñ“ª”ò“í“ö“¢”®“∞“Æ–Ü“∫]/;
    return kazakhChars.test(text) ? 'kk' : 'ru';
}

        function getIconForSection(text) {
            text = text.toLowerCase();
            
            if (text.includes('–≤–≤–µ–¥–µ–Ω–∏–µ') || text.includes('–Ω–∞—á–∞–ª–æ')) return 'play-circle';
            if (text.includes('–æ—Å–Ω–æ–≤') || text.includes('–∫–æ–Ω—Ü–µ–ø')) return 'cube';
            if (text.includes('—Å—Ç—Ä—É–∫—Ç—É—Ä') || text.includes('–∞—Ä—Ö–∏—Ç–µ–∫—Ç')) return 'sitemap';
            if (text.includes('—Ñ—É–Ω–∫—Ü–∏') || text.includes('–º–µ—Ç–æ–¥')) return 'code';
            if (text.includes('–¥–∞–Ω–Ω—ã') || text.includes('–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏')) return 'database';
            if (text.includes('–∞–ª–≥–æ—Ä–∏—Ç–º') || text.includes('–ª–æ–≥–∏–∫')) return 'brain';
            if (text.includes('–ø—Ä–∏–º–µ—Ä') || text.includes('–ø—Ä–∞–∫—Ç–∏–∫')) return 'clipboard-list';
            if (text.includes('–±–µ–∑–æ–ø–∞—Å–Ω') || text.includes('–∑–∞—â–∏—Ç')) return 'shield-alt';
            if (text.includes('–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏') || text.includes('–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω')) return 'tachometer-alt';
            if (text.includes('—Ç–µ—Å—Ç–∏—Ä–æ–≤') || text.includes('–æ—Ç–ª–∞–¥–∫')) return 'bug';
            if (text.includes('–∑–∞–∫–ª—é—á–µ–Ω–∏') || text.includes('–∏—Ç–æ–≥')) return 'flag-checkered';
            
            return 'book-open';
        }

        function createCodeBlock(code, language) {
            const languageNames = {
                'js': 'JavaScript',
                'javascript': 'JavaScript',
                'py': 'Python',
                'python': 'Python',
                'html': 'HTML',
                'css': 'CSS',
                'java': 'Java',
                'cpp': 'C++',
                'c': 'C',
                'php': 'PHP',
                'sql': 'SQL',
                'bash': 'Bash',
                'json': 'JSON'
            };
            
            const langName = languageNames[language.toLowerCase()] || language;
            const codeId = 'code-' + Math.random().toString(36).substr(2, 9);
            
            return `
                <div class="code-block">
                    <div class="code-header">
                        <span><i class="fas fa-code"></i>${langName}</span>
                        <button class="copy-btn" onclick="copyCode('${codeId}')">
                            <i class="fas fa-copy"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                    </div>
                    <div class="code-body">
                        <pre><code id="${codeId}" class="language-${language}">${escapeHtml(code)}</code></pre>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        function copyCode(codeId) {
            const codeElement = document.getElementById(codeId);
            const text = codeElement.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target.closest('.copy-btn');
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                }, 2000);
            });
        }

        
        window.onload = initApp;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è HTML
        window.switchLanguage = switchLanguage;
        window.toggleTheme = toggleTheme;
        window.backToHome = backToHome;
        window.showMainPage = showMainPage;
        window.loadCourse = loadCourse;
        window.deleteCourse = deleteCourse;
        window.handleFileSelect = handleFileSelect;
        window.generateMicrolearning = generateMicrolearning;
        window.openModule = openModule;
        window.completeModule = completeModule;
        window.prevTheoryPage = prevTheoryPage;
        window.nextTheoryPage = nextTheoryPage;
        window.flipCard = flipCard;
        window.prevCard = prevCard;
        window.nextCard = nextCard;
        window.selectAnswer = selectAnswer;
        window.prevQuestion = prevQuestion;
        window.nextQuestion = nextQuestion;
        window.submitTextQuiz = submitTextQuiz;
        window.updatePracticalCode = updatePracticalCode;
        window.runCode = runCode;
        window.checkPracticalAnswer = checkPracticalAnswer;
        window.prevPractical = prevPractical;
        window.nextPractical = nextPractical;
        window.generateCertificate = generateCertificate;
        window.showCongratulations = showCongratulations;
        window.downloadCertificate = downloadCertificate;
        window.backToLearning = backToLearning;
        window.showCertificatePreview = showCertificatePreview;
        window.canProceedToNext = canProceedToNext;
        window.updateShortAnswer = updateShortAnswer;
        window.checkShortAnswer = checkShortAnswer;
    </script>
</body>
</html>